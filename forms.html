<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <style>
        body { background-color: #f4f7f6; } 
        .container { max-width: 800px; background-color: #ffffff; padding: 2.5rem; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.05); margin-top: 2rem; margin-bottom: 2rem;} 
        .form-header { text-align: center; margin-bottom: 2rem; } 
        .required-field { color: #d9534f; } 
        .form-section { border-top: 1px solid #dee2e6; padding-top: 1.5rem; margin-top: 1.5rem; } 
        .hidden-section, .other-text { display: none; } 
        .checkbox-group .form-check { display: inline-block; width: 48%; margin-right: 1%; } 
        #loadingSpinner { display: none; } 
        .select2-container--bootstrap-5 .select2-selection { min-height: calc(3.5rem + 2px); } 
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered { line-height: 3.5rem; }
        .validation-error { border-color: #dc3545 !important; box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25); }
        .error-message { color: #dc3545; font-size: 0.875em; margin-top: 0.25rem; }
        .form-progress { height: 4px; background-color: #e9ecef; border-radius: 2px; margin-bottom: 1rem; }
        .form-progress-bar { height: 100%; background-color: #28a745; border-radius: 2px; transition: width 0.3s ease; }
        .autosave-status { position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 0.5rem 1rem; font-size: 0.875rem; border-radius: 4px; }
        .offline-notice { background-color: #ffc107; color: #856404; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; display: none; }
        /* FIXED: Add reward trip section styles for minor forms too */
        .reward-trip-section { border: 1px solid #dee2e6; background-color: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-top: 1rem; }
        .radio-button-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .radio-button-group .form-check { margin: 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="offline-notice" id="offlineNotice">
            <strong>Connection Lost:</strong> Working offline. Your data will be saved locally and submitted when connection is restored.
        </div>

        <div class="form-header">
            <h1>Discipline Referral Form</h1>
            <div class="form-progress">
                <div class="form-progress-bar" id="formProgress" style="width: 20%;"></div>
            </div>
        </div>

        <div id="loadingSpinner" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Submitting form...</p>
            <div class="progress mt-3" style="height: 6px;">
                <div class="progress-bar bg-primary" id="submitProgress" role="progressbar" style="width: 0%"></div>
            </div>
        </div>

        <form id="referralForm" novalidate>
            <div class="row g-3">
                <div class="col-md-12">
                    <label for="studentName" class="form-label">Student Name <span class="required-field">*</span></label>
                    <select id="studentName" name="studentName" class="form-select" required></select>
                    <div class="error-message" id="studentName-error"></div>
                </div>
                <div class="col-md-12">
                    <label class="form-label">Referral Type <span class="required-field">*</span></label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="referralType" id="referralMinor" value="Minor" required>
                            <label class="form-check-label" for="referralMinor">Minor</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="referralType" id="referralMajor" value="Major" required>
                            <label class="form-check-label" for="referralMajor">Major</label>
                        </div>
                    </div>
                    <div class="error-message" id="referralType-error"></div>
                </div>
            </div>
            
            <div id="dynamicFormSection" class="hidden-section">
                <div class="form-section">
                    <h4 id="formDetailsTitle"></h4>
                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <label for="staffName" class="form-label">Staff Name <span class="required-field">*</span></label>
                            <input type="text" class="form-control" id="staffName" name="staffName" required maxlength="100">
                            <div class="error-message" id="staffName-error"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="staffEmail" class="form-label">Staff Email <span class="required-field">*</span></label>
                            <input type="email" class="form-control" id="staffEmail" name="staffEmail" required maxlength="100">
                            <div class="error-message" id="staffEmail-error"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="dateOfIncident" class="form-label">Date of Incident <span class="required-field">*</span></label>
                            <input type="date" class="form-control" id="dateOfIncident" name="dateOfIncident" required>
                            <div class="error-message" id="dateOfIncident-error"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="timeOfIncident" class="form-label">Time of Incident</label>
                            <input type="time" class="form-control" id="timeOfIncident" name="timeOfIncident">
                            <div class="error-message" id="timeOfIncident-error"></div>
                        </div>
                        <div class="col-md-12">
                            <label for="location" class="form-label">Location <span class="required-field">*</span></label>
                            <select class="form-select" id="location" name="Location" required>
                                <option selected disabled value="">Choose...</option>
                                <option>Classroom</option><option>Hallway</option><option>Cafeteria</option><option>Music Room</option><option>Restroom</option><option>Bus</option><option>Bus Zone</option><option>Gymnasium</option><option>Locker Room</option><option>Office</option><option>Other</option>
                            </select>
                            <div class="error-message" id="location-error"></div>
                        </div>
                    </div>
                    
                    <div id="minorInfractionSection" class="mt-4 hidden-section">
                        <label class="form-label">Minor Infraction(s) <span class="required-field">*</span></label>
                        <div class="p-3 border rounded checkbox-group">
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Tardies/Late to class"><label class="form-check-label">Tardies/Late to class</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Cell Phone Violation"><label class="form-check-label">Cell Phone Violation</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Lack of Materials"><label class="form-check-label">Lack of Materials</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Classroom Behavior"><label class="form-check-label">Classroom Behavior</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Disruptive Classroom Behavior"><label class="form-check-label">Disruptive Classroom Behavior</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Horseplay"><label class="form-check-label">Horseplay</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Public Display of Affection"><label class="form-check-label">Public Display of Affection</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Electronic Device"><label class="form-check-label">Electronic Device</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Profanity (Low Level)"><label class="form-check-label">Profanity (Low Level)</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Loitering"><label class="form-check-label">Loitering</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Inappropriate Language"><label class="form-check-label">Inappropriate Language</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Academic Dishonesty"><label class="form-check-label">Academic Dishonesty</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Vandalism (low level)"><label class="form-check-label">Vandalism (low level)</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Bus Behavior"><label class="form-check-label">Bus Behavior</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Cafeteria Behavior"><label class="form-check-label">Cafeteria Behavior</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorInfractions" value="Other" data-other-target="infractionOtherText"><label class="form-check-label">Other</label></div>
                        </div>
                        <div class="error-message" id="MinorInfractions-error"></div>
                    </div>

                    <div id="majorInfractionSection" class="mt-4 hidden-section">
                        <label class="form-label">Major Infraction(s) <span class="required-field">*</span></label>
                        <div class="p-3 border rounded checkbox-group">
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Absent/late to Class or School"><label class="form-check-label">Absent/late to Class or School</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="High Intensity Disrespect to Staff"><label class="form-check-label">High Intensity Disrespect to Staff</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Disruption of Education"><label class="form-check-label">Disruption of Education</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Failure to Report for Detention"><label class="form-check-label">Failure to Report for Detention</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Failure to Follow Class Rules"><label class="form-check-label">Failure to Follow Class Rules</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Harrassment"><label class="form-check-label">Harrassment</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Horseplay"><label class="form-check-label">Horseplay</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Insubordination"><label class="form-check-label">Insubordination</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="High Intensity Profanity"><label class="form-check-label">High Intensity Profanity</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Possession/Use/Sale of Alcohol/Drugs/Tobacco/Counterfeit"><label class="form-check-label">Possession/Use/Sale of Alcohol/Drugs/Tobacco/Counterfeit</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Participation in a Physical Altercation"><label class="form-check-label">Participation in a Physical Altercation</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Threatening Harm to Students or Staff"><label class="form-check-label">Threatening Harm to Students or Staff</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Vandalism"><label class="form-check-label">Vandalism</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Academic Dishonesty"><label class="form-check-label">Academic Dishonesty</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorInfractions" value="Other" data-other-target="infractionOtherText"><label class="form-check-label">Other</label></div>
                        </div>
                        <div class="error-message" id="MajorInfractions-error"></div>
                    </div>

                    <input type="text" class="form-control mt-2 other-text" id="infractionOtherText" name="infractionOtherText" placeholder="Please specify other infraction" maxlength="500">

                    <div class="mt-3">
                        <label for="descriptionOfInfraction" class="form-label">Description of Infraction <span class="required-field">*</span></label>
                        <textarea class="form-control" id="descriptionOfInfraction" name="descriptionOfInfraction" rows="3" placeholder="Provide a detailed, objective account of the incident." required maxlength="2000"></textarea>
                        <div class="form-text">Characters remaining: <span id="descriptionCounter">2000</span></div>
                        <div class="error-message" id="descriptionOfInfraction-error"></div>
                    </div>

                    <div id="minorActionsSection" class="mt-4 hidden-section">
                        <label class="form-label">Previous Action(s) Taken <span class="required-field">*</span></label>
                        <div class="p-3 border rounded checkbox-group">
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Warning"><label class="form-check-label">Warning</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Assigned Different Seat"><label class="form-check-label">Assigned Different Seat</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Called Home"><label class="form-check-label">Called Home</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Behavior Contract"><label class="form-check-label">Behavior Contract</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Conference with Student"><label class="form-check-label">Conference with Student</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Conference with Team Teachers"><label class="form-check-label">Conference with Team Teachers</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Conference with Parent"><label class="form-check-label">Conference with Parent</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Detention"><label class="form-check-label">Detention</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Exclusion from Participation"><label class="form-check-label">Exclusion from Participation</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Guidance Referral"><label class="form-check-label">Guidance Referral</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Restorative Meeting"><label class="form-check-label">Restorative Meeting</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Behavior Slips"><label class="form-check-label">Behavior Slips</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MinorActionsTaken" value="Other" data-other-target="actionsTakenOtherText"><label class="form-check-label">Other</label></div>
                        </div>
                        <div class="error-message" id="MinorActionsTaken-error"></div>
                    </div>

                    <div id="majorActionsSection" class="mt-4 hidden-section">
                        <label class="form-label">Previous Action(s) Taken <span class="required-field">*</span></label>
                        <div class="p-3 border rounded checkbox-group">
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Warning"><label class="form-check-label">Warning</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Assigned Different Seat"><label class="form-check-label">Assigned Different Seat</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Called Home"><label class="form-check-label">Called Home</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Behavior Contract"><label class="form-check-label">Behavior Contract</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Conference with Student"><label class="form-check-label">Conference with Student</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Conference with Team Teachers"><label class="form-check-label">Conference with Team Teachers</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Conference with Parent"><label class="form-check-label">Conference with Parent</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Detention"><label class="form-check-label">Detention</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Exclusion from Participation"><label class="form-check-label">Exclusion from Participation</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Guidance Referral"><label class="form-check-label">Guidance Referral</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Restorative Meeting"><label class="form-check-label">Restorative Meeting</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Saturday Detention"><label class="form-check-label">Saturday Detention</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Suspension"><label class="form-check-label">Suspension</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Expulsion"><label class="form-check-label">Expulsion</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="MajorActionsTaken" value="Other" data-other-target="actionsTakenOtherText"><label class="form-check-label">Other</label></div>
                        </div>
                        <div class="error-message" id="MajorActionsTaken-error"></div>
                    </div>

                    <input type="text" class="form-control mt-2 other-text" id="actionsTakenOtherText" name="actionsTakenOtherText" placeholder="Please specify other action taken" maxlength="500">

                    <div class="mt-4">
                        <label class="form-label">Perceived Motivation <span class="required-field">*</span></label>
                        <div class="p-3 border rounded checkbox-group">
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="PerceivedMotivation" value="Obtain Peer Attention" required><label class="form-check-label">Obtain Peer Attention</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="PerceivedMotivation" value="Avoid Tasks/Activities"><label class="form-check-label">Avoid Tasks/Activities</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="PerceivedMotivation" value="Obtain Items"><label class="form-check-label">Obtain Items</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="PerceivedMotivation" value="Obtain Adult Attention"><label class="form-check-label">Obtain Adult Attention</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="PerceivedMotivation" value="Avoid Adult"><label class="form-check-label">Avoid Adult</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="PerceivedMotivation" value="Avoid Peer"><label class="form-check-label">Avoid Peer</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="PerceivedMotivation" value="Avoid Work/Activities"><label class="form-check-label">Avoid Work/Activities</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="PerceivedMotivation" value="Peer to Peer Issues"><label class="form-check-label">Peer to Peer Issues</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="PerceivedMotivation" value="Social Emotional Issues"><label class="form-check-label">Social Emotional Issues</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="PerceivedMotivation" value="School Avoidance"><label class="form-check-label">School Avoidance</label></div>
                        </div>
                        <div class="error-message" id="PerceivedMotivation-error"></div>
                    </div>

                    <!-- FIXED: Home Communication Section - only for Major referrals -->
                    <div id="parentCommunicationSection" class="mt-4 hidden-section">
                        <label class="form-label">Home Communication <span class="required-field">*</span></label>
                        <div class="p-3 border rounded">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="HomeCommunications" id="homeCommunicationCheckbox" value="Yes">
                                <label class="form-check-label" for="homeCommunicationCheckbox">Phone communication with parent/guardian?</label>
                            </div>
                            <div class="mt-3 other-text" id="detailsOfCommunicationWrapper">
                                <label for="detailsOfCommunication" class="form-label">Details of Communication</label>
                                <textarea class="form-control" id="detailsOfCommunication" name="DetailsOfCommunication" rows="3" maxlength="1000"></textarea>
                            </div>
                        </div>
                        <div class="error-message" id="HomeCommunications-error"></div>
                    </div>

                    <div class="mt-3">
                        <label for="comments" class="form-label">Additional Comments</label>
                        <textarea class="form-control" id="comments" name="Comments" rows="3" maxlength="1000"></textarea>
                        <div class="form-text">Characters remaining: <span id="commentsCounter">1000</span></div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">Submit Referral</button>
                        <button type="button" class="btn btn-secondary" id="saveDraftBtn">Save Draft</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="autosave-status" id="autosaveStatus" style="display: none;"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // Global variables
        const SCRIPT_URL = <?!= JSON.stringify(scriptUrl) ?>;
        let formData = {};
        let isOnline = navigator.onLine;
        let autoSaveTimer;
        const AUTOSAVE_DELAY = 30000; // 30 seconds
        let formProgress = 0;

        $(document).ready(function() {
            initializeForm();
            setupEventListeners();
            loadStudentNames();
            setupOfflineDetection();
            setupFormValidation();
            setupCharacterCounters();
            loadDraftFromStorage();
            updateFormProgress();
        });

        function initializeForm() {
            $('#studentName').select2({ 
                theme: "bootstrap-5", 
                placeholder: 'Loading students...' 
            }).prop('disabled', true);
            
            document.getElementById('dateOfIncident').valueAsDate = new Date();
        }

        function setupEventListeners() {
            // Student name change - FIXED: Load student info and grade
            $('#studentName').on('select2:select', function(e) {
                const selectedStudent = e.params.data.text;
                loadStudentInfo(selectedStudent);
                updateFormProgress();
            });

            // Referral type change
            $('input[name="referralType"]').change(function() {
                const referralType = $(this).val();
                $('#formDetailsTitle').text(referralType + " Referral Details");
                $('#dynamicFormSection').slideDown();
                
                if (referralType === 'Minor') {
                    $('#minorInfractionSection, #minorActionsSection').slideDown();
                    $('#majorInfractionSection, #majorActionsSection, #parentCommunicationSection').slideUp();
                    $('#homeCommunicationCheckbox').prop('required', false);
                    // REMOVED: No reward trip section for forms
                } else if (referralType === 'Major') {
                    $('#majorInfractionSection, #majorActionsSection, #parentCommunicationSection').slideDown();
                    $('#minorInfractionSection, #minorActionsSection').slideUp();
                    $('#homeCommunicationCheckbox').prop('required', true);
                }
                updateFormProgress();
            });

            // Other field toggles
            $('input[type="checkbox"][data-other-target]').on('change', function() {
                const targetInput = $('#' + $(this).data('other-target'));
                if (this.checked) { 
                    targetInput.slideDown(); 
                } else { 
                    targetInput.slideUp().val(''); 
                }
            });

            // FIXED: Home communication toggle - proper handling
            $('#homeCommunicationCheckbox').on('change', function() {
                const detailsWrapper = $('#detailsOfCommunicationWrapper');
                if (this.checked) { 
                    detailsWrapper.slideDown(); 
                } else { 
                    detailsWrapper.slideUp(); 
                    $('#detailsOfCommunication').val(''); // Clear details when unchecked
                }
            });

            // Form input changes for autosave and progress
            $('#referralForm').on('input change', 'input, textarea, select', function() {
                clearTimeout(autoSaveTimer);
                updateFormProgress();
                
                if (isOnline) {
                    autoSaveTimer = setTimeout(() => {
                        saveDraftLocally();
                        showAutosaveStatus('Draft saved locally', 'success');
                    }, AUTOSAVE_DELAY);
                }
            });

            // Save draft button
            $('#saveDraftBtn').click(function() {
                saveDraftLocally();
                showAutosaveStatus('Draft saved successfully!', 'success');
            });
        }

        function loadStudentInfo(studentName) {
            google.script.run
                .withSuccessHandler(function(studentInfo) {
                    // Student info loaded successfully
                    // No reward trip setup needed in forms
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading student info:', error);
                })
                .getStudentInfoByNameOptimized(studentName);
        }

        function loadStudentNames() {
            google.script.run
                .withSuccessHandler(onStudentNamesLoaded)
                .withFailureHandler(onStudentNamesLoadError)
                .getStudentNamesOptimized();
        }

        function onStudentNamesLoaded(names) {
            const select2Data = names.map(name => ({ id: name, text: name }));
            $('#studentName').select2({ 
                theme: "bootstrap-5", 
                placeholder: 'Search and select a student...', 
                data: select2Data 
            }).prop('disabled', false);
            updateFormProgress();
        }

        function onStudentNamesLoadError(error) {
            console.error('Student names load error:', error);
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-warning mt-3';
            errorDiv.innerHTML = `
                <strong>Warning:</strong> Could not load student names from database. 
                You can still type the student name manually, but please verify spelling.
                <br><small>Technical error: ${error.message}</small>
            `;
            
            const studentSelect = document.getElementById('studentName');
            const container = studentSelect.parentElement;
            
            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.className = 'form-control';
            textInput.id = 'studentName';
            textInput.name = 'studentName';
            textInput.required = true;
            textInput.placeholder = 'Enter student name manually';
            
            container.replaceChild(textInput, studentSelect);
            container.appendChild(errorDiv);
            updateFormProgress();
        }

        function setupOfflineDetection() {
            window.addEventListener('online', () => {
                isOnline = true;
                $('#offlineNotice').hide();
                showAutosaveStatus('Connection restored', 'success');
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                $('#offlineNotice').show();
                showAutosaveStatus('Working offline', 'warning');
            });
        }

        function setupFormValidation() {
            const form = document.getElementById('referralForm');
            form.addEventListener('submit', handleFormSubmit);
            
            // Real-time validation
            form.addEventListener('blur', function(e) {
                if (e.target.hasAttribute('required')) {
                    validateField(e.target);
                }
            }, true);
        }

        function setupCharacterCounters() {
            $('#descriptionOfInfraction').on('input', function() {
                const remaining = 2000 - this.value.length;
                $('#descriptionCounter').text(remaining);
                $('#descriptionCounter').toggleClass('text-danger', remaining < 100);
            });

            $('#comments').on('input', function() {
                const remaining = 1000 - this.value.length;
                $('#commentsCounter').text(remaining);
                $('#commentsCounter').toggleClass('text-danger', remaining < 50);
            });
        }

        function validateField(field) {
            clearFieldError(field);
            
            let isValid = true;
            let errorMessage = '';

            if (field.hasAttribute('required') && !field.value.trim()) {
                isValid = false;
                errorMessage = 'This field is required';
            } else if (field.type === 'email' && field.value && !isValidEmail(field.value)) {
                isValid = false;
                errorMessage = 'Please enter a valid email address';
            } else if (field.type === 'date' && field.value) {
                const date = new Date(field.value);
                const today = new Date();
                const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                
                if (date > today) {
                    isValid = false;
                    errorMessage = 'Date cannot be in the future';
                } else if (date < oneYearAgo) {
                    isValid = false;
                    errorMessage = 'Date cannot be more than one year ago';
                }
            }

            if (!isValid) {
                showFieldError(field, errorMessage);
            }

            return isValid;
        }

        function validateCheckboxGroup(name) {
            const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
            if (checkboxes.length === 0) {
                const container = document.querySelector(`input[name="${name}"]`).closest('.checkbox-group');
                showFieldError(container, `Please select at least one ${name.toLowerCase()}`, name);
                return false;
            }
            clearFieldError(null, name);
            return true;
        }

        function showFieldError(field, message, fieldName = null) {
            const errorId = fieldName ? `${fieldName}-error` : `${field.id || field.name}-error`;
            const errorDiv = document.getElementById(errorId);
            
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
            
            if (field && field.classList) {
                field.classList.add('validation-error');
            }
        }

        function clearFieldError(field, fieldName = null) {
            const errorId = fieldName ? `${fieldName}-error` : `${field.id || field.name}-error`;
            const errorDiv = document.getElementById(errorId);
            
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }
            
            if (field && field.classList) {
                field.classList.remove('validation-error');
            }
        }

        function validateFormData(formObject) {
            const errors = [];
            
            // Required field checks
            if (!formObject.studentName?.trim()) {
                errors.push('Student name is required');
            }
            
            if (!formObject.staffName?.trim()) {
                errors.push('Staff name is required');
            }
            
            if (!formObject.staffEmail?.trim() || !isValidEmail(formObject.staffEmail)) {
                errors.push('Valid staff email is required');
            }
            
            if (!formObject.dateOfIncident) {
                errors.push('Date of incident is required');
            }
            
            if (!formObject.descriptionOfInfraction?.trim()) {
                errors.push('Description of infraction is required');
            }
            
            // Check if infractions are selected
            const hasMinorInfractions = formObject.MinorInfractions;
            const hasMajorInfractions = formObject.MajorInfractions;
            
            if (!hasMinorInfractions && !hasMajorInfractions) {
                errors.push('At least one infraction must be selected');
            }
            
            // Check actions taken
            const hasMinorActions = formObject.MinorActionsTaken;
            const hasMajorActions = formObject.MajorActionsTaken;
            
            if (!hasMinorActions && !hasMajorActions) {
                errors.push('At least one previous action must be selected');
            }

            // Check perceived motivation
            if (!formObject.PerceivedMotivation) {
                errors.push('Perceived motivation must be selected');
            }
            
            return errors;
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function updateFormProgress() {
            const form = document.getElementById('referralForm');
            const allInputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
            const visibleInputs = Array.from(allInputs).filter(input => {
                const container = input.closest('.hidden-section, .other-text');
                return !container || container.style.display !== 'none';
            });
            
            const filledInputs = visibleInputs.filter(input => {
                if (input.type === 'radio') {
                    return form.querySelector(`input[name="${input.name}"]:checked`);
                } else if (input.type === 'checkbox') {
                    return form.querySelectorAll(`input[name="${input.name}"]:checked`).length > 0;
                } else {
                    return input.value.trim() !== '';
                }
            });
            
            const progress = visibleInputs.length > 0 ? Math.round((filledInputs.length / visibleInputs.length) * 100) : 0;
            document.getElementById('formProgress').style.width = progress + '%';
            formProgress = progress;
        }

        function saveDraftLocally() {
            const formData = collectFormData();
            localStorage.setItem('referralDraft', JSON.stringify(formData));
            localStorage.setItem('referralDraftTimestamp', Date.now().toString());
        }

        function loadDraftFromStorage() {
            try {
                const draft = localStorage.getItem('referralDraft');
                const timestamp = localStorage.getItem('referralDraftTimestamp');
                
                if (draft && timestamp) {
                    const draftAge = Date.now() - parseInt(timestamp);
                    const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                    
                    if (draftAge < maxAge) {
                        const formData = JSON.parse(draft);
                        populateFormWithData(formData);
                        showAutosaveStatus('Draft loaded from previous session', 'info');
                    } else {
                        // Clean up old draft
                        localStorage.removeItem('referralDraft');
                        localStorage.removeItem('referralDraftTimestamp');
                    }
                }
            } catch (error) {
                console.error('Error loading draft:', error);
            }
        }

        function populateFormWithData(data) {
            Object.keys(data).forEach(key => {
                const element = document.querySelector(`[name="${key}"]`);
                if (element) {
                    if (element.type === 'radio' || element.type === 'checkbox') {
                        if (Array.isArray(data[key])) {
                            data[key].forEach(value => {
                                const checkbox = document.querySelector(`[name="${key}"][value="${value}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        } else {
                            element.checked = true;
                        }
                    } else {
                        element.value = data[key];
                    }
                }
            });
            updateFormProgress();
        }

        // FIXED: Collect form data without checkbox duplication
        function collectFormData() {
            const form = document.getElementById('referralForm');
            const formObject = {};
            
            // Handle regular inputs
            const inputs = form.querySelectorAll('input:not([type="checkbox"]):not([type="radio"]), textarea, select');
            inputs.forEach(input => {
                if (input.name && input.value) {
                    formObject[input.name] = input.value;
                }
            });

            // FIXED: Handle checkboxes properly - avoid duplication
            const checkboxGroups = {};
            form.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                const name = cb.getAttribute('name');
                if (name) {
                    if (!checkboxGroups[name]) {
                        checkboxGroups[name] = [];
                    }
                    checkboxGroups[name].push(cb.value);
                }
            });
            
            // Join checkbox values with proper formatting
            Object.keys(checkboxGroups).forEach(name => {
                formObject[name] = checkboxGroups[name].join(', ');
            });

            // Handle radio buttons
            form.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                if (radio.name) {
                    formObject[radio.name] = radio.value;
                }
            });

            // FIXED: Handle home communication checkbox properly
            const homeCommCheckbox = document.getElementById('homeCommunicationCheckbox');
            if (homeCommCheckbox && homeCommCheckbox.checked) {
                formObject.HomeCommunications = 'on'; // This will be converted to "Yes" in the backend
            }
            
            return formObject;
        }

        function showAutosaveStatus(message, type = 'info') {
            const statusDiv = document.getElementById('autosaveStatus');
            statusDiv.className = `autosave-status alert alert-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        function updateSubmitProgress(percent, message) {
            document.getElementById('submitProgress').style.width = percent + '%';
            const loadingText = document.querySelector('#loadingSpinner p');
            if (loadingText) loadingText.textContent = message;
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            const form = this;
            const formObject = collectFormData();
            
            // Validate form data
            const validationErrors = validateFormData(formObject);
            
            // Additional checkbox validation
            const referralType = formObject.referralType;
            if (referralType === 'Minor') {
                if (!validateCheckboxGroup('MinorInfractions')) {
                    validationErrors.push('Please select at least one minor infraction');
                }
                if (!validateCheckboxGroup('MinorActionsTaken')) {
                    validationErrors.push('Please select at least one previous action taken');
                }
            } else if (referralType === 'Major') {
                if (!validateCheckboxGroup('MajorInfractions')) {
                    validationErrors.push('Please select at least one major infraction');
                }
                if (!validateCheckboxGroup('MajorActionsTaken')) {
                    validationErrors.push('Please select at least one previous action taken');
                }
            }
            
            if (!validateCheckboxGroup('PerceivedMotivation')) {
                validationErrors.push('Please select at least one perceived motivation');
            }
            
            if (validationErrors.length > 0) {
                alert('Please fix the following errors:\n\n' + validationErrors.join('\n'));
                return;
            }
            
            // Show loading state
            document.getElementById('loadingSpinner').style.display = 'block';
            form.style.display = 'none';
            
            updateSubmitProgress(20, 'Validating form data...');
            
            setTimeout(() => {
                updateSubmitProgress(50, 'Submitting to server...');
                
                google.script.run
                    .withSuccessHandler(response => {
                        updateSubmitProgress(100, 'Processing complete!');
                        
                        setTimeout(() => {
                            // Clear draft from storage
                            localStorage.removeItem('referralDraft');
                            localStorage.removeItem('referralDraftTimestamp');
                            setTimeout(() => {
                              window.location.href = 'https://script.google.com/a/macros/ofcs.net/s/AKfycbxodrS7lw0ihs07yscxXSBn38-vmAoybJoLfbPc6yNT9sFjhFkRsST5aPmdNah6AZOL/exec';
                            }, 2500);
                            alert(response);
                            setTimeout(() => window.location.reload(), 1000);
                        }, 1000);
                    })
                    .withFailureHandler(error => {
                        console.error('Submission error:', error);
                        alert('Submission failed: ' + error.message + '\n\nPlease try again or contact IT support.');
                        document.getElementById('loadingSpinner').style.display = 'none';
                        form.style.display = 'block';
                    })
                    .processFormSecure(formObject);
            }, 1000);
        }
    </script>
</body>
</html>
