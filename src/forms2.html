<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <style>
        body {
            background-color: #f4f7f6;
        }

        .container {
            max-width: 800px;
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .form-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .required-field {
            color: #d9534f;
        }

        .form-section {
            border-top: 1px solid #dee2e6;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }

        .hidden-section,
        .other-text {
            display: none;
        }

        .checkbox-group .form-check {
            display: inline-block;
            width: 48%;
            margin-right: 1%;
        }

        #loadingSpinner {
            display: none;
        }

        .select2-container--bootstrap-5 .select2-selection {
            min-height: calc(3.5rem + 2px);
        }

        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            line-height: 3.5rem;
        }

        .validation-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
        }

        .form-progress {
            height: 4px;
            background-color: #e9ecef;
            border-radius: 2px;
            margin-bottom: 1rem;
        }

        .form-progress-bar {
            height: 100%;
            background-color: #28a745;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .autosave-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 4px;
        }

        .offline-notice {
            background-color: #ffc107;
            color: #856404;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }

        .reward-trip-section {
            border: 1px solid #dee2e6;
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .radio-button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .radio-button-group .form-check {
            margin: 0;
        }

        .required-group.validation-error {
            border: 2px solid #dc3545 !important;
            background-color: rgba(220, 53, 69, 0.05);
            border-radius: 8px;
            padding: 1rem;
        }

        .required-group.validation-error .form-label {
            color: #dc3545;
            font-weight: bold;
        }

        .checkbox-group.validation-error {
            border: 2px solid #dc3545 !important;
            background-color: rgba(220, 53, 69, 0.05);
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .radio-group.validation-error {
            border: 2px solid #dc3545 !important;
            background-color: rgba(220, 53, 69, 0.05);
            padding: 0.75rem;
            border-radius: 8px;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="offline-notice" id="offlineNotice">
            <strong>Connection Lost:</strong> Working offline. Your data will be saved locally and submitted when
            connection
            is restored.
        </div>

        <div class="form-header">
            <h1>Discipline Referral Form</h1>
            <div class="form-progress">
                <div class="form-progress-bar" id="formProgress" style="width: 20%;"></div>
            </div>
        </div>

        <div id="loadingSpinner" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Submitting form...</p>
            <div class="progress mt-3" style="height: 6px;">
                <div class="progress-bar bg-primary" id="submitProgress" role="progressbar" style="width: 0%"></div>
            </div>
        </div>
        <form id="referralForm" novalidate>
            <div class="row g-3">
                <div class="col-md-12 required-group" id="studentName-group">
                    <label for="studentName" class="form-label">Student Name <span
                            class="required-field">*</span></label>
                    <select id="studentName" name="studentName" class="form-select" required>
                        <option value="" disabled selected>Choose a student</option>
                    </select>
                    <div class="error-message" id="studentName-error"></div>
                </div>
                <!-- Replace the existing radio button section (around line 324-335) with: -->
                <div class="col-md-12 required-group" id="referralType-group">
                    <label class="form-label">Referral Type <span class="required-field">*</span></label>
                    <div class="radio-group">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="referralType" id="referralMinor"
                                value="Minor" required>
                            <label class="form-check-label" for="referralMinor">Minor</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="referralType" id="referralMajor"
                                value="Major" required>
                            <label class="form-check-label" for="referralMajor">Major</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="referralType" id="referralPositive"
                                value="Positive" required>
                            <label class="form-check-label" for="referralPositive">Positive</label>
                        </div>
                    </div>
                    <div class="error-message" id="referralType-error"></div>
                </div>
            </div>

            <div id="dynamicFormSection" class="hidden-section">
                <div class="form-section">
                    <h4 id="formDetailsTitle"></h4>
                    <div class="row g-3 mt-1">
                        <div class="col-md-6 required-group" id="staffName-group">
                            <label for="staffName" class="form-label">Staff Name <span
                                    class="required-field">*</span></label>
                            <input type="text" class="form-control" id="staffName" name="staffName" required
                                maxlength="100">
                            <div class="error-message" id="staffName-error"></div>
                        </div>
                        <div class="col-md-6 required-group" id="staffEmail-group">
                            <label for="staffEmail" class="form-label">Staff Email <span
                                    class="required-field">*</span></label>
                            <input type="email" class="form-control" id="staffEmail" name="staffEmail" required
                                maxlength="100">
                            <div class="error-message" id="staffEmail-error"></div>
                        </div>
                        <div class="col-md-6 required-group" id="dateOfIncident-group">
                            <label for="dateOfIncident" class="form-label">Date of Incident <span
                                    class="required-field">*</span></label>
                            <input type="date" class="form-control" id="dateOfIncident" name="dateOfIncident" required>
                            <div class="error-message" id="dateOfIncident-error"></div>
                        </div>
                        <div class="col-md-6" id="timeOfIncident-group">
                            <label for="timeOfIncident" class="form-label">Time of Incident</label>
                            <input type="time" class="form-control" id="timeOfIncident" name="timeOfIncident">
                            <div class="error-message" id="timeOfIncident-error"></div>
                        </div>
                        <div class="col-md-12 required-group" id="location-group">
                            <label for="location" class="form-label">Location <span
                                    class="required-field">*</span></label>
                            <select class="form-select" id="location" name="Location" required>
                                <option selected disabled value="">Choose...</option>
                                <option>Classroom</option>
                                <option>Hallway</option>
                                <option>Cafeteria</option>
                                <option>Music Room</option>
                                <option>Restroom</option>
                                <option>Bus</option>
                                <option>Bus Zone</option>
                                <option>Gymnasium</option>
                                <option>Locker Room</option>
                                <option>Office</option>
                                <option>Other</option>
                            </select>
                            <div class="error-message" id="location-error"></div>
                        </div>
                    </div>
                    <div id="minorInfractionSection" class="mt-4 hidden-section required-group">
                        <label class="form-label">Minor Infraction(s) <span class="required-field">*</span></label>
                        <div class="p-3 border rounded checkbox-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions1" value="Tardies/Late to class"><label class="form-check-label"
                                    for="MinorInfractions1">Tardies/Late to class</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions2" value="Cell Phone Violation"><label class="form-check-label"
                                    for="MinorInfractions2">Cell Phone Violation</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions3" value="Lack of Materials"><label class="form-check-label"
                                    for="MinorInfractions3">Lack of Materials</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions4" value="Classroom Behavior"><label class="form-check-label"
                                    for="MinorInfractions4">Classroom Behavior</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions5" value="Disruptive Classroom Behavior"><label
                                    class="form-check-label" for="MinorInfractions5">Disruptive Classroom
                                    Behavior</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions6" value="Horseplay"><label class="form-check-label"
                                    for="MinorInfractions6">Horseplay</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions7" value="Public Display of Affection"><label
                                    class="form-check-label" for="MinorInfractions7">Public Display of Affection</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions8" value="Electronic Device"><label class="form-check-label"
                                    for="MinorInfractions8">Electronic Device</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions9" value="Profanity (Low Level)"><label class="form-check-label"
                                    for="MinorInfractions9">Profanity (Low Level)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions10" value="Loitering"><label class="form-check-label"
                                    for="MinorInfractions10">Loitering</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions11" value="Inappropriate Language"><label
                                    class="form-check-label" for="MinorInfractions11">Inappropriate Language</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions12" value="Academic Dishonesty"><label class="form-check-label"
                                    for="MinorInfractions12">Academic Dishonesty</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions13" value="Vandalism (low level)"><label
                                    class="form-check-label" for="MinorInfractions13">Vandalism (low level)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions14" value="Bus Behavior"><label class="form-check-label"
                                    for="MinorInfractions14">Bus Behavior</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions15" value="Cafeteria Behavior"><label class="form-check-label"
                                    for="MinorInfractions15">Cafeteria Behavior</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorInfractions"
                                    id="MinorInfractions16" value="Other" data-other-target="infractionOtherText"><label
                                    class="form-check-label" for="MinorInfractions16">Other</label>
                            </div>
                        </div>
                        <div class="error-message" id="MinorInfractions-error"></div>
                    </div>

                    <div id="majorInfractionSection" class="mt-4 hidden-section required-group">
                        <label class="form-label">Major Infraction(s) <span class="required-field">*</span></label>
                        <div class="p-3 border rounded checkbox-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions1" value="Absent/late to Class or School"><label
                                    class="form-check-label" for="MajorInfractions1">Absent/late to Class or
                                    School</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions2" value="High Intensity Disrespect to Staff"><label
                                    class="form-check-label" for="MajorInfractions2">High Intensity Disrespect to
                                    Staff</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions3" value="Disruption of Education"><label
                                    class="form-check-label" for="MajorInfractions3">Disruption of Education</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions4" value="Failure to Report for Detention"><label
                                    class="form-check-label" for="MajorInfractions4">Failure to Report for
                                    Detention</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions5" value="Failure to Follow Class Rules"><label
                                    class="form-check-label" for="MajorInfractions5">Failure to Follow Class
                                    Rules</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions6" value="Harrassment"><label class="form-check-label"
                                    for="MajorInfractions6">Harrassment</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions7" value="Horseplay"><label class="form-check-label"
                                    for="MajorInfractions7">Horseplay</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions8" value="Insubordination"><label class="form-check-label"
                                    for="MajorInfractions8">Insubordination</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions9" value="High Intensity Profanity"><label
                                    class="form-check-label" for="MajorInfractions9">High Intensity Profanity</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions10"
                                    value="Possession/Use/Sale of Alcohol/Drugs/Tobacco/Counterfeit"><label
                                    class="form-check-label" for="MajorInfractions10">Possession/Use/Sale of
                                    Alcohol/Drugs/Tobacco/Counterfeit</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions11" value="Participation in a Physical Altercation"><label
                                    class="form-check-label" for="MajorInfractions11">Participation in a Physical
                                    Altercation</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions12" value="Threatening Harm to Students or Staff"><label
                                    class="form-check-label" for="MajorInfractions12">Threatening Harm to Students or
                                    Staff</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions13" value="Vandalism"><label class="form-check-label"
                                    for="MajorInfractions13">Vandalism</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions14" value="Academic Dishonesty"><label class="form-check-label"
                                    for="MajorInfractions14">Academic Dishonesty</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorInfractions"
                                    id="MajorInfractions15" value="Other" data-other-target="infractionOtherText"><label
                                    class="form-check-label" for="MajorInfractions15">Other</label>
                            </div>
                        </div>
                        <div class="error-message" id="MajorInfractions-error"></div>
                    </div>

                    <input type="text" class="form-control mt-2 other-text" id="infractionOtherText"
                        name="infractionOtherText" placeholder="Please specify other infraction" maxlength="500">
                    <div class="mt-3 required-group" id="descriptionOfInfraction-group">
                        <label for="descriptionOfInfraction" class="form-label">Description of Infraction <span
                                class="required-field">*</span></label>
                        <textarea class="form-control" id="descriptionOfInfraction" name="descriptionOfInfraction"
                            rows="3" placeholder="Provide a detailed, objective account of the incident." required
                            maxlength="2000"></textarea>
                        <div class="form-text">Characters remaining: <span id="descriptionCounter">2000</span></div>
                        <div class="error-message" id="descriptionOfInfraction-error"></div>
                    </div>

                    <div id="minorActionsSection" class="mt-4 hidden-section required-group">
                        <label class="form-label">Previous Action(s) Taken <span class="required-field">*</span></label>
                        <div class="p-3 border rounded checkbox-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken1" value="Warning"><label class="form-check-label"
                                    for="MinorActionsTaken1">Warning</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken2" value="Assigned Different Seat"><label
                                    class="form-check-label" for="MinorActionsTaken2">Assigned Different Seat</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken3" value="Called Home"><label class="form-check-label"
                                    for="MinorActionsTaken3">Called Home</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken4" value="Behavior Contract"><label class="form-check-label"
                                    for="MinorActionsTaken4">Behavior Contract</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken5" value="Conference with Student"><label
                                    class="form-check-label" for="MinorActionsTaken5">Conference with Student</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken6" value="Conference with Team Teachers"><label
                                    class="form-check-label" for="MinorActionsTaken6">Conference with Team
                                    Teachers</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken7" value="Conference with Parent"><label
                                    class="form-check-label" for="MinorActionsTaken7">Conference with Parent</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken8" value="Detention"><label class="form-check-label"
                                    for="MinorActionsTaken8">Detention</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken9" value="Exclusion from Participation"><label
                                    class="form-check-label" for="MinorActionsTaken9">Exclusion from
                                    Participation</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken10" value="Guidance Referral"><label class="form-check-label"
                                    for="MinorActionsTaken10">Guidance Referral</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken11" value="Restorative Meeting"><label class="form-check-label"
                                    for="MinorActionsTaken11">Restorative Meeting</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken12" value="Behavior Slips"><label class="form-check-label"
                                    for="MinorActionsTaken12">Behavior Slips</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MinorActionsTaken"
                                    id="MinorActionsTaken13" value="Other"
                                    data-other-target="actionsTakenOtherText"><label class="form-check-label"
                                    for="MinorActionsTaken13">Other</label>
                            </div>
                        </div>
                        <div class="error-message" id="MinorActionsTaken-error"></div>
                    </div>

                    <!-- Positive Behavior Recognition Section -->
                    <div id="positiveSection" class="mt-4 hidden-section required-group">
                        <div class="alert alert-success">
                            <h5>ðŸŒŸ Positive Behavior Recognition</h5>
                            <p>You're recognizing a student for positive behavior! Please select the type of positive
                                behavior
                                observed.</p>
                        </div>

                        <div class="mt-3 required-group" id="PositiveBehavior-group">
                            <label class="form-label">Type of Positive Behavior <span
                                    class="required-field">*</span></label>
                            <div class="p-3 border rounded">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="PositiveBehavior"
                                        id="PositiveBehavior1" value="Safe" required>
                                    <label class="form-check-label" for="PositiveBehavior1">
                                        <strong>Safe</strong> - Following safety rules, helping maintain a safe
                                        environment
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="PositiveBehavior"
                                        id="PositiveBehavior2" value="Respectful">
                                    <label class="form-check-label" for="PositiveBehavior2">
                                        <strong>Respectful</strong> - Showing respect to peers, staff, and property
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="PositiveBehavior"
                                        id="PositiveBehavior3" value="Responsible">
                                    <label class="form-check-label" for="PositiveBehavior3">
                                        <strong>Responsible</strong> - Taking ownership of actions and assignments
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="PositiveBehavior"
                                        id="PositiveBehavior4" value="Kind">
                                    <label class="form-check-label" for="PositiveBehavior4">
                                        <strong>Kind</strong> - Showing kindness and compassion to others
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="PositiveBehavior"
                                        id="PositiveBehavior5" value="Attendance">
                                    <label class="form-check-label" for="PositiveBehavior5">
                                        <strong>Attendance</strong> - Excellent or improved attendance
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="PositiveBehavior"
                                        id="PositiveBehavior6" value="Academic Progress">
                                    <label class="form-check-label" for="PositiveBehavior6">
                                        <strong>Academic Progress</strong> - Showing improvement or excellence in
                                        academics
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="PositiveBehavior"
                                        id="PositiveBehavior7" value="Engaged">
                                    <label class="form-check-label" for="PositiveBehavior7">
                                        <strong>Engaged</strong> - Active participation and engagement in learning
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="PositiveBehavior"
                                        id="PositiveBehavior8" value="Creative">
                                    <label class="form-check-label" for="PositiveBehavior8">
                                        <strong>Creative</strong> - Demonstrating creativity and innovation
                                    </label>
                                </div>
                            </div>
                            <div class="error-message" id="PositiveBehavior-error"></div>
                        </div>
                    </div>

                    <div id="majorActionsSection" class="mt-4 hidden-section required-group">
                        <label class="form-label">Previous Action(s) Taken <span class="required-field">*</span></label>
                        <div class="p-3 border rounded checkbox-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken1" value="Warning"><label class="form-check-label"
                                    for="MajorActionsTaken1">Warning</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken2" value="Assigned Different Seat"><label
                                    class="form-check-label" for="MajorActionsTaken2">Assigned Different Seat</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken3" value="Called Home"><label class="form-check-label"
                                    for="MajorActionsTaken3">Called Home</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken4" value="Behavior Contract"><label class="form-check-label"
                                    for="MajorActionsTaken4">Behavior Contract</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken5" value="Conference with Student"><label
                                    class="form-check-label" for="MajorActionsTaken5">Conference with Student</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken6" value="Conference with Team Teachers"><label
                                    class="form-check-label" for="MajorActionsTaken6">Conference with Team
                                    Teachers</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken7" value="Conference with Parent"><label
                                    class="form-check-label" for="MajorActionsTaken7">Conference with Parent</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken8" value="Detention"><label class="form-check-label"
                                    for="MajorActionsTaken8">Detention</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken9" value="Exclusion from Participation"><label
                                    class="form-check-label" for="MajorActionsTaken9">Exclusion from
                                    Participation</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken10" value="Guidance Referral"><label class="form-check-label"
                                    for="MajorActionsTaken10">Guidance Referral</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken11" value="Restorative Meeting"><label class="form-check-label"
                                    for="MajorActionsTaken11">Restorative Meeting</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken12" value="Saturday Detention"><label class="form-check-label"
                                    for="MajorActionsTaken12">Saturday Detention</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken13" value="Suspension"><label class="form-check-label"
                                    for="MajorActionsTaken13">Suspension</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken14" value="Expulsion"><label class="form-check-label"
                                    for="MajorActionsTaken14">Expulsion</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="MajorActionsTaken"
                                    id="MajorActionsTaken15" value="Other"
                                    data-other-target="actionsTakenOtherText"><label class="form-check-label"
                                    for="MajorActionsTaken15">Other</label>
                            </div>
                        </div>
                        <div class="error-message" id="MajorActionsTaken-error"></div>
                    </div>

                    <input type="text" class="form-control mt-2 other-text" id="actionsTakenOtherText"
                        name="actionsTakenOtherText" placeholder="Please specify other action taken" maxlength="500">

                    <div class="mt-4 required-group" id="PerceivedMotivation-group">
                        <label class="form-label">Perceived Motivation <span class="required-field">*</span></label>
                        <div class="p-3 border rounded checkbox-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="PerceivedMotivation"
                                    id="PerceivedMotivation1" value="Obtain Peer Attention" required><label
                                    class="form-check-label" for="PerceivedMotivation1">Obtain Peer Attention</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="PerceivedMotivation"
                                    id="PerceivedMotivation2" value="Avoid Tasks/Activities"><label
                                    class="form-check-label" for="PerceivedMotivation2">Avoid Tasks/Activities</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="PerceivedMotivation"
                                    id="PerceivedMotivation3" value="Obtain Items"><label class="form-check-label"
                                    for="PerceivedMotivation3">Obtain Items</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="PerceivedMotivation"
                                    id="PerceivedMotivation4" value="Obtain Adult Attention"><label
                                    class="form-check-label" for="PerceivedMotivation4">Obtain Adult Attention</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="PerceivedMotivation"
                                    id="PerceivedMotivation5" value="Avoid Adult"><label class="form-check-label"
                                    for="PerceivedMotivation5">Avoid Adult</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="PerceivedMotivation"
                                    id="PerceivedMotivation6" value="Avoid Peer"><label class="form-check-label"
                                    for="PerceivedMotivation6">Avoid Peer</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="PerceivedMotivation"
                                    id="PerceivedMotivation7" value="Avoid Work/Activities"><label
                                    class="form-check-label" for="PerceivedMotivation7">Avoid Work/Activities</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="PerceivedMotivation"
                                    id="PerceivedMotivation8" value="Peer to Peer Issues"><label
                                    class="form-check-label" for="PerceivedMotivation8">Peer to Peer Issues</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="PerceivedMotivation"
                                    id="PerceivedMotivation9" value="Social Emotional Issues"><label
                                    class="form-check-label" for="PerceivedMotivation9">Social Emotional Issues</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="PerceivedMotivation"
                                    id="PerceivedMotivation10" value="School Avoidance"><label class="form-check-label"
                                    for="PerceivedMotivation10">School Avoidance</label>
                            </div>
                        </div>
                        <div class="error-message" id="PerceivedMotivation-error"></div>
                    </div>
                    <!-- FIXED: Home Communication Section - only for Major referrals with proper validation -->
                    <div id="parentCommunicationSection" class="mt-4 hidden-section required-group">
                        <label class="form-label">Home Communication <span class="required-field">*</span></label>
                        <div class="p-3 border rounded">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="HomeCommunications"
                                    id="homeCommunicationCheckbox" value="Yes" required>
                                <label class="form-check-label" for="homeCommunicationCheckbox">Phone communication with
                                    parent/guardian?</label>
                            </div>
                            <div class="mt-3 other-text" id="detailsOfCommunicationWrapper">
                                <label for="detailsOfCommunication" class="form-label">Details of Communication</label>
                                <textarea class="form-control" id="detailsOfCommunication" name="DetailsOfCommunication"
                                    rows="3" maxlength="1000"></textarea>
                            </div>
                        </div>
                        <div class="error-message" id="HomeCommunications-error"></div>
                    </div>

                    <div class="mt-3">
                        <label for="comments" class="form-label">Additional Comments</label>
                        <textarea class="form-control" id="comments" name="Comments" rows="3"
                            maxlength="1000"></textarea>
                        <div class="form-text">Characters remaining: <span id="commentsCounter">1000</span></div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">Submit Referral</button>
                        <button type="button" class="btn btn-secondary" id="saveDraftBtn">Save Draft</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="autosave-status" id="autosaveStatus" style="display: none;"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // Global variables
        const SCRIPT_URL = <?!= JSON.stringify(scriptUrl) ?>;
        let formData = {};
        let isOnline = navigator.onLine;
        let autoSaveTimer;
        const AUTOSAVE_DELAY = 30000; // 30 seconds
        let formProgress = 0;

        $(document).ready(function () {
            initializeForm();
            setupEventListeners();
            loadStudentNames();
            setupOfflineDetection();
            setupFormValidation();
            setupCharacterCounters();
            loadDraftFromStorage();
            updateFormProgress();
        });

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
        });

        function initializeForm() {
            $('#studentName').select2({
                theme: "bootstrap-5",
                placeholder: 'Loading students...'
            }).prop('disabled', true);

            // FIXED: Set today's date in the correct format for the date input
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('dateOfIncident').value = `${year}-${month}-${day}`;
        }
        function setupEventListeners() {
            // Student name change - FIXED: Load student info and grade
            $('#studentName').on('select2:select', function (e) {
                const selectedStudent = e.params.data.text;
                loadStudentInfo(selectedStudent);
                updateFormProgress();
            });

            // Referral type change
            $('input[name="referralType"]').change(function () {
                const referralType = $(this).val();
                console.log('Referral type selected:', referralType); // Debug line

                $('#formDetailsTitle').text(referralType + " Referral Details");
                $('#dynamicFormSection').slideDown();

                if (referralType === 'Minor') {
                    // Show Minor-specific sections
                    $('#minorInfractionSection, #minorActionsSection').slideDown();
                    $('#majorInfractionSection, #majorActionsSection, #parentCommunicationSection, #positiveSection').slideUp();

                    // Show all standard fields
                    $('.form-section .row.g-3').show();
                    $('#timeOfIncident-group, #location-group').closest('.col-md-6, .col-md-12').show();
                    $('#descriptionOfInfraction-group').show();
                    $('#PerceivedMotivation-group').closest('.mt-4').show();

                    // Update labels
                    $('label[for="comments"]').text('Additional Comments');

                    // Remove required for home communication
                    $('#homeCommunicationCheckbox').prop('required', false);
                    $('#parentCommunicationSection').removeClass('required-group');

                } else if (referralType === 'Major') {
                    // Show Major-specific sections
                    $('#majorInfractionSection, #majorActionsSection, #parentCommunicationSection').slideDown();
                    $('#minorInfractionSection, #minorActionsSection, #positiveSection').slideUp();

                    // Show all standard fields
                    $('.form-section .row.g-3').show();
                    $('#timeOfIncident-group, #location-group').closest('.col-md-6, .col-md-12').show();
                    $('#descriptionOfInfraction-group').show();
                    $('#PerceivedMotivation-group').closest('.mt-4').show();

                    // Update labels
                    $('label[for="comments"]').text('Additional Comments');

                    // Add required for home communication
                    $('#homeCommunicationCheckbox').prop('required', true);
                    $('#parentCommunicationSection').addClass('required-group');

                } else if (referralType === 'Positive') {
                    console.log('Positive selected - showing positive section'); // Debug line

                    // Show Positive section
                    $('#positiveSection').slideDown();

                    // Hide all infraction/action sections
                    $('#minorInfractionSection, #majorInfractionSection, #minorActionsSection, #majorActionsSection, #parentCommunicationSection').slideUp();

                    // Hide unnecessary fields for Positive referrals
                    $('#timeOfIncident-group').closest('.col-md-6').hide();
                    $('#location-group').closest('.col-md-12').hide();
                    $('#descriptionOfInfraction-group').hide();
                    $('#PerceivedMotivation-group').closest('.mt-4').hide();

                    // Clear values from hidden fields
                    $('#timeOfIncident, #location, #descriptionOfInfraction').val('').prop('required', false);
                    $('input[name="PerceivedMotivation"]').prop('checked', false);

                    // Update the comments label for positive feedback
                    $('label[for="comments"]').text('Positive Feedback Details');

                    // Remove required attributes
                    $('#homeCommunicationCheckbox').prop('required', false);
                }

                updateFormProgress();
            });

            // Other field toggles
            $('input[type="checkbox"][data-other-target]').on('change', function () {
                const targetInput = $('#' + $(this).data('other-target'));
                if (this.checked) {
                    targetInput.slideDown();
                } else {
                    targetInput.slideUp().val('');
                }
            });

            // FIXED: Home communication toggle - proper handling
            $('#homeCommunicationCheckbox').on('change', function () {
                const detailsWrapper = $('#detailsOfCommunicationWrapper');
                if (this.checked) {
                    detailsWrapper.slideDown();
                } else {
                    detailsWrapper.slideUp();
                    $('#detailsOfCommunication').val(''); // Clear details when unchecked
                }
                // FIXED: Clear validation error when checkbox is checked
                if (this.checked) {
                    clearFieldError(null, 'HomeCommunications');
                    $('#parentCommunicationSection').removeClass('validation-error');
                }
            });

            // Form input changes for autosave and progress
            $('#referralForm').on('input change', 'input, textarea, select', function () {
                clearTimeout(autoSaveTimer);
                updateFormProgress();

                // FIXED: Clear validation errors on input change
                if (this.classList.contains('validation-error')) {
                    clearFieldError(this);
                }

                // Clear group validation errors
                const group = $(this).closest('.required-group');
                if (group.hasClass('validation-error')) {
                    group.removeClass('validation-error');
                }

                if (isOnline) {
                    autoSaveTimer = setTimeout(() => {
                        saveDraftLocally();
                        showAutosaveStatus('Draft saved locally', 'success');
                    }, AUTOSAVE_DELAY);
                }
            });

            // Save draft button
            $('#saveDraftBtn').click(function () {
                saveDraftLocally();
                showAutosaveStatus('Draft saved successfully!', 'success');
            });
        }

        function loadStudentInfo(studentName) {
            google.script.run
                .withSuccessHandler(function (studentInfo) {
                    // Student info loaded successfully
                    // No reward trip setup needed in forms
                })
                .withFailureHandler(function (error) {
                    console.error('Error loading student info:', error);
                })
                .getStudentInfoByNameOptimized(studentName);
        }

        function loadStudentNames() {
            google.script.run
                .withSuccessHandler(onStudentNamesLoaded)
                .withFailureHandler(onStudentNamesLoadError)
                .getStudentNamesOptimized();
        }

        // FIXED: Student names loaded with proper default option
        function onStudentNamesLoaded(names) {
            const select2Data = names.map(name => ({ id: name, text: name }));
            $('#studentName').select2({
                theme: "bootstrap-5",
                placeholder: 'Choose a student',
                data: select2Data
            }).prop('disabled', false);
            updateFormProgress();
        }

        function onStudentNamesLoadError(error) {
            console.error('Student names load error:', error);

            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-warning mt-3';
            errorDiv.innerHTML = `
                <strong>Warning:</strong> Could not load student names from database. 
                You can still type the student name manually, but please verify spelling.
                <br><small>Technical error: ${error.message}</small>
            `;

            const studentSelect = document.getElementById('studentName');
            const container = studentSelect.parentElement;

            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.className = 'form-control';
            textInput.id = 'studentName';
            textInput.name = 'studentName';
            textInput.required = true;
            textInput.placeholder = 'Enter student name manually';

            container.replaceChild(textInput, studentSelect);
            container.appendChild(errorDiv);
            updateFormProgress();
        }
        function setupOfflineDetection() {
            window.addEventListener('online', () => {
                isOnline = true;
                $('#offlineNotice').hide();
                showAutosaveStatus('Connection restored', 'success');
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                $('#offlineNotice').show();
                showAutosaveStatus('Working offline', 'warning');
            });
        }

        function setupFormValidation() {
            const form = document.getElementById('referralForm');
            form.addEventListener('submit', handleFormSubmit);

            // Real-time validation
            form.addEventListener('blur', function (e) {
                if (e.target.hasAttribute('required')) {
                    validateField(e.target);
                }
            }, true);
        }

        function setupCharacterCounters() {
            $('#descriptionOfInfraction').on('input', function () {
                const remaining = 2000 - this.value.length;
                $('#descriptionCounter').text(remaining);
                $('#descriptionCounter').toggleClass('text-danger', remaining < 100);
            });

            $('#comments').on('input', function () {
                const remaining = 1000 - this.value.length;
                $('#commentsCounter').text(remaining);
                $('#commentsCounter').toggleClass('text-danger', remaining < 50);
            });

            $('#positiveDetails').on('input', function () {
                const remaining = 500 - this.value.length;
                $('#positiveDetailsCounter').text(remaining);
                $('#positiveDetailsCounter').toggleClass('text-danger', remaining < 50);
            });
        }

        function validateField(field) {
            clearFieldError(field);

            let isValid = true;
            let errorMessage = '';

            if (field.hasAttribute('required') && !field.value.trim()) {
                isValid = false;
                errorMessage = 'This field is required';
            } else if (field.type === 'email' && field.value && !isValidEmail(field.value)) {
                isValid = false;
                errorMessage = 'Please enter a valid email address';
            } else if (field.type === 'date' && field.value) {
                const date = new Date(field.value);
                const today = new Date();
                const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());

                if (date > today) {
                    isValid = false;
                    errorMessage = 'Date cannot be in the future';
                } else if (date < oneYearAgo) {
                    isValid = false;
                    errorMessage = 'Date cannot be more than one year ago';
                }
            }

            if (!isValid) {
                showFieldError(field, errorMessage);
            }

            return isValid;
        }

        // FIXED: Enhanced validation for checkbox groups with visual styling
        function validateCheckboxGroup(name, isRequired = true) {
            const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
            const container = document.querySelector(`input[name="${name}"]`).closest('.required-group');

            if (isRequired && checkboxes.length === 0) {
                showFieldError(container, `Please select at least one ${name.toLowerCase().replace(/([A-Z])/g, ' $1')}`, name);
                container.classList.add('validation-error');
                return false;
            }

            clearFieldError(container, name);
            container.classList.remove('validation-error');
            return true;
        }

        // FIXED: Enhanced validation for radio groups with visual styling
        function validateRadioGroup(name, isRequired = true) {
            const radios = document.querySelectorAll(`input[name="${name}"]:checked`);
            const container = document.querySelector(`input[name="${name}"]`).closest('.required-group');

            if (isRequired && radios.length === 0) {
                showFieldError(container, `Please select a ${name.toLowerCase().replace(/([A-Z])/g, ' $1')}`, name);
                container.classList.add('validation-error');
                return false;
            }

            clearFieldError(container, name);
            container.classList.remove('validation-error');
            return true;
        }

        // FIXED: Enhanced field error display with group styling
        function showFieldError(field, message, fieldName = null) {
            const errorId = fieldName ? `${fieldName}-error` : `${field.id || field.name}-error`;
            const errorDiv = document.getElementById(errorId);

            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }

            if (field && field.classList) {
                field.classList.add('validation-error');
                // Also add to parent group if it exists
                const group = field.closest('.required-group');
                if (group) {
                    group.classList.add('validation-error');
                }
            }
        }

        // FIXED: Enhanced field error clearing with group styling
        function clearFieldError(field, fieldName = null) {
            const errorId = fieldName ? `${fieldName}-error` : `${field?.id || field?.name}-error`;
            const errorDiv = document.getElementById(errorId);

            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }

            if (field && field.classList) {
                field.classList.remove('validation-error');
                // Also remove from parent group if it exists
                const group = field.closest('.required-group');
                if (group) {
                    group.classList.remove('validation-error');
                }
            }
        }
        // FIXED: Enhanced form validation with proper Major referral home communication check
        function validateFormData(formObject) {
            const errors = [];
            let allValid = true;

            // Clear all previous validation errors
            document.querySelectorAll('.validation-error').forEach(el => {
                el.classList.remove('validation-error');
            });
            document.querySelectorAll('.error-message').forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });

            // Always required fields (for ALL referral types)
            if (!formObject.studentName?.trim()) {
                errors.push('Student name is required');
                showFieldError(document.getElementById('studentName'), 'Student name is required');
                allValid = false;
            }

            if (!formObject.staffName?.trim()) {
                errors.push('Staff name is required');
                showFieldError(document.getElementById('staffName'), 'Staff name is required');
                allValid = false;
            }

            if (!formObject.staffEmail?.trim() || !isValidEmail(formObject.staffEmail)) {
                errors.push('Valid staff email is required');
                showFieldError(document.getElementById('staffEmail'), 'Valid staff email is required');
                allValid = false;
            }

            if (!formObject.dateOfIncident) {
                errors.push('Date of incident is required');
                showFieldError(document.getElementById('dateOfIncident'), 'Date of incident is required');
                allValid = false;
            }

            // Validate referral type
            if (!validateRadioGroup('referralType')) {
                errors.push('Referral type must be selected');
                allValid = false;
            }

            const referralType = formObject.referralType;

            // FIXED: Handle Positive referrals FIRST - they have different requirements
            if (referralType === 'Positive') {
                // Validate that a positive behavior type is selected
                const positiveBehavior = document.querySelector('input[name="PositiveBehavior"]:checked');
                if (!positiveBehavior) {
                    errors.push('Please select a type of positive behavior');
                    showFieldError(document.getElementById('PositiveBehavior-group'), 'Please select a type of positive behavior', 'PositiveBehavior');
                    allValid = false;
                }
                // For positive referrals, we're done - return early
                return errors;
            }

            // FIXED: Fields only required for Minor and Major referrals (NOT Positive)
            if (!formObject.Location) {
                errors.push('Location is required');
                showFieldError(document.getElementById('location'), 'Location is required');
                allValid = false;
            }

            if (!formObject.descriptionOfInfraction?.trim()) {
                errors.push('Description of infraction is required');
                showFieldError(document.getElementById('descriptionOfInfraction'), 'Description of infraction is required');
                allValid = false;
            }

            // Check perceived motivation (required for Minor and Major only)
            if (!validateCheckboxGroup('PerceivedMotivation')) {
                errors.push('Perceived motivation must be selected');

                function isValidEmail(email) {
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                }

                function updateFormProgress() {
                    const form = document.getElementById('referralForm');
                    const allInputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
                    const visibleInputs = Array.from(allInputs).filter(input => {
                        const container = input.closest('.hidden-section, .other-text');
                        return !container || container.style.display !== 'none';
                    });

                    const filledInputs = visibleInputs.filter(input => {
                        if (input.type === 'radio') {
                            return form.querySelector(`input[name="${input.name}"]:checked`);
                        } else if (input.type === 'checkbox') {
                            return form.querySelectorAll(`input[name="${input.name}"]:checked`).length > 0;
                        } else {
                            return input.value.trim() !== '';
                        }
                    });

                    const progress = visibleInputs.length > 0 ? Math.round((filledInputs.length / visibleInputs.length) * 100) : 0;
                    document.getElementById('formProgress').style.width = progress + '%';
                    formProgress = progress;
                }

                function saveDraftLocally() {
                    const formData = collectFormData();
                    localStorage.setItem('referralDraft', JSON.stringify(formData));
                    localStorage.setItem('referralDraftTimestamp', Date.now().toString());
                }

                function loadDraftFromStorage() {
                    try {
                        const draft = localStorage.getItem('referralDraft');
                        const timestamp = localStorage.getItem('referralDraftTimestamp');

                        if (draft && timestamp) {
                            const draftAge = Date.now() - parseInt(timestamp);
                            const maxAge = 24 * 60 * 60 * 1000; // 24 hours

                            if (draftAge < maxAge) {
                                const formData = JSON.parse(draft);
                                populateFormWithData(formData);
                                showAutosaveStatus('Draft loaded from previous session', 'info');
                            } else {
                                // Clean up old draft
                                localStorage.removeItem('referralDraft');
                                localStorage.removeItem('referralDraftTimestamp');
                            }
                        }
                    } catch (error) {
                        console.error('Error loading draft:', error);
                    }
                }

                function populateFormWithData(data) {
                    Object.keys(data).forEach(key => {
                        const element = document.querySelector(`[name="${key}"]`);
                        if (element) {
                            if (element.type === 'radio' || element.type === 'checkbox') {
                                if (Array.isArray(data[key])) {
                                    data[key].forEach(value => {
                                        const checkbox = document.querySelector(`[name="${key}"][value="${value}"]`);
                                        if (checkbox) checkbox.checked = true;
                                    });
                                } else {
                                    element.checked = true;
                                }
                            } else {
                                element.value = data[key];
                            }
                        }
                    });
                    updateFormProgress();
                }

                // FIXED: Collect form data and convert dates/times to text strings immediately
                // FIXED: Collect form data and convert dates/times to text strings immediately
                function collectFormData() {
                    const form = document.getElementById('referralForm');
                    const formObject = {};

                    // Handle regular inputs
                    const inputs = form.querySelectorAll('input:not([type="checkbox"]):not([type="radio"]), textarea, select');
                    inputs.forEach(input => {
                        if (input.name && input.value) {
                            // FIXED: Convert date and time inputs to formatted text strings immediately
                            if (input.type === 'date') {
                                formObject[input.name] = formatDateFromInput(input.value);
                            } else if (input.type === 'time') {
                                // DEBUG: Log the time value
                                console.log('TIME DEBUG - Raw time value:', input.value);
                                const formattedTime = formatTimeFromInput(input.value);
                                console.log('TIME DEBUG - Formatted time:', formattedTime);
                                formObject[input.name] = formattedTime;
                            } else {
                                formObject[input.name] = input.value;
                            }
                        }
                    });

                    // DEBUG: Log the final form object
                    console.log('FORM DATA DEBUG:', formObject);

                    // Handle checkboxes properly - avoid duplication
                    const checkboxGroups = {};
                    form.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                        const name = cb.getAttribute('name');
                        if (name) {
                            if (!checkboxGroups[name]) {
                                checkboxGroups[name] = [];
                            }
                            checkboxGroups[name].push(cb.value);
                        }
                    });

                    // Join checkbox values with proper formatting
                    Object.keys(checkboxGroups).forEach(name => {
                        formObject[name] = checkboxGroups[name].join(', ');
                    });

                    // Handle radio buttons
                    form.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                        if (radio.name) {
                            formObject[radio.name] = radio.value;
                        }
                    });

                    // Handle home communication checkbox properly
                    const homeCommCheckbox = document.getElementById('homeCommunicationCheckbox');
                    if (homeCommCheckbox && homeCommCheckbox.checked) {
                        formObject.HomeCommunications = 'on'; // This will be converted to "Yes" in the backend
                    }

                    return formObject;
                }

                // FIXED: Add these helper functions to convert HTML input values to our desired text format
                function formatDateFromInput(dateString) {
                    if (!dateString) return '';

                    // dateString is in YYYY-MM-DD format from HTML date input
                    const [year, month, day] = dateString.split('-');
                    const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));

                    const options = {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    };
                    return date.toLocaleDateString('en-US', options);
                }

                function formatTimeFromInput(timeString) {
                    if (!timeString) return '';

                    // timeString is in HH:MM format from HTML time input
                    const [hours, minutes] = timeString.split(':');
                    const date = new Date(2000, 0, 1, parseInt(hours), parseInt(minutes));

                    const options = {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    };
                    return date.toLocaleTimeString('en-US', options);
                }

                function showAutosaveStatus(message, type = 'info') {
                    const statusDiv = document.getElementById('autosaveStatus');
                    statusDiv.className = `autosave-status alert alert-${type}`;
                    statusDiv.textContent = message;
                    statusDiv.style.display = 'block';

                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                }

                function updateSubmitProgress(percent, message) {
                    document.getElementById('submitProgress').style.width = percent + '%';
                    const loadingText = document.querySelector('#loadingSpinner p');
                    if (loadingText) loadingText.textContent = message;
                }

                // FIXED: Enhanced form submission with proper validation and visual feedback
                function handleFormSubmit(e) {
                    e.preventDefault();

                    const form = this;
                    const formObject = collectFormData();

                    // Validate form data with enhanced visual feedback
                    const validationErrors = validateFormData(formObject);

                    if (validationErrors.length > 0) {
                        // Scroll to first error
                        const firstError = document.querySelector('.validation-error');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }

                        alert('Please fix the following errors:\n\n' + validationErrors.join('\n'));
                        return;
                    }

                    // Show loading state
                    document.getElementById('loadingSpinner').style.display = 'block';
                    form.style.display = 'none';

                    updateSubmitProgress(20, 'Validating form data...');

                    setTimeout(() => {
                        updateSubmitProgress(50, 'Submitting to server...');

                        google.script.run
                            .withSuccessHandler(response => {
                                updateSubmitProgress(100, 'Processing complete!');

                                setTimeout(() => {
                                    // Clear draft from storage
                                    localStorage.removeItem('referralDraft');
                                    localStorage.removeItem('referralDraftTimestamp');

                                    // FIXED: Call the proper reset function instead of window.location.reload()
                                    resetFormForNewStudent();
                                }, 1000);
                            })
                            .withFailureHandler(error => {
                                console.error('Submission error:', error);
                                alert('Submission failed: ' + error.message + '\n\nPlease try again or contact IT support.');
                                document.getElementById('loadingSpinner').style.display = 'none';
                                form.style.display = 'block';
                            })
                            .processFormSecure(formObject);
                    }, 1000);
                }

                // FIXED: Add this function to forms.html to replace the problematic window.location.reload()
                function resetFormForNewStudent() {
                    // Hide loading spinner and show form
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('referralForm').style.display = 'block';

                    // Clear the form
                    const form = document.getElementById('referralForm');
                    form.reset();

                    // Reset Select2 dropdown - check if element exists first
                    const studentSelect = document.getElementById('studentName');
                    if (studentSelect && $(studentSelect).hasClass('select2-hidden-accessible')) {
                        $('#studentName').val(null).trigger('change');
                    }

                    // Hide all conditional sections
                    $('#dynamicFormSection').slideUp();
                    $('#minorInfractionSection, #majorInfractionSection').slideUp();
                    $('#minorActionsSection, #majorActionsSection').slideUp();
                    $('#parentCommunicationSection').slideUp();

                    // Clear all error messages and validation styling
                    document.querySelectorAll('.error-message').forEach(errorDiv => {
                        if (errorDiv) {
                            errorDiv.textContent = '';
                            errorDiv.style.display = 'none';
                        }
                    });

                    // Remove validation error classes
                    document.querySelectorAll('.validation-error').forEach(element => {
                        element.classList.remove('validation-error');
                    });

                    // Reset character counters - check if elements exist
                    const descCounter = document.getElementById('descriptionCounter');
                    const commentsCounter = document.getElementById('commentsCounter');

                    if (descCounter) descCounter.textContent = '2000';
                    if (commentsCounter) commentsCounter.textContent = '1000';

                    // Reset form progress
                    const progressBar = document.getElementById('formProgress');
                    if (progressBar) progressBar.style.width = '20%';

                    // Clear draft from storage
                    localStorage.removeItem('referralDraft');
                    localStorage.removeItem('referralDraftTimestamp');

                    // Reset date to today
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const dateField = document.getElementById('dateOfIncident');
                    if (dateField) dateField.value = `${year}-${month}-${day}`;

                    // Show success message with option to add another
                    const successHtml = `
                <div class="alert alert-success fade show" role="alert">
                    <h5>Referral Submitted Successfully!</h5>
                    <p>The referral has been submitted and the administrator has been notified.</p>
                    <p>You may CLOSE this window or REFRESH the browser to enter another referral.</p>
                </div>
            `;

                    // Replace form content temporarily
                    const container = document.querySelector('.container');
                    const originalForm = container.innerHTML;
                    container.innerHTML = successHtml;

                    // Store original form for restoration
                    window.originalFormHtml = originalForm;
                }
    </script>
</body>

</html>