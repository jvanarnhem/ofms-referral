<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; } 
        .container { max-width: 900px; background-color: #ffffff; padding: 2.5rem; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.05); margin-top: 2rem; margin-bottom: 2rem; } 
        .form-header h1 { color: #d9534f; } 
        .btn-danger { background-color: #d9534f; border-color: #d9534f; } 
        .staff-section { border: 1px solid #dee2e6; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; } 
        .admin-section { border: 2px solid #d9534f; background-color: #fcf8f7; padding: 1.5rem; border-radius: 8px; } 
        .form-control[readonly], textarea[readonly] { background-color: #e9ecef; cursor: not-allowed; } 
        #loader { display: flex; justify-content: center; align-items: center; height: 50vh; } 
        #adminForm { display: none; } 
        .checkbox-group .form-check { display: inline-block; width: 48%; } 
        .radio-group .form-check { display: inline-block; margin-right: 1rem; } 
        .other-text, .hidden-section { display: none; }
        .validation-error { border-color: #dc3545 !important; box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25); }
        .error-message { color: #dc3545; font-size: 0.875em; margin-top: 0.25rem; }
        .progress-container { margin-bottom: 1rem; }
        .autosave-status { position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 0.5rem 1rem; font-size: 0.875rem; border-radius: 4px; }
        .submission-summary { background-color: #e7f3ff; border: 1px solid #b3d7ff; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .quick-actions { position: sticky; top: 20px; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .field-highlight { background-color: #fff3cd; border-left: 4px solid #ffc107; padding-left: 0.75rem; }
        .reward-trip-section { border: 1px solid #dee2e6; background-color: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-top: 1rem; }
        .radio-button-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .radio-button-group .form-check { margin: 0; }
        .completed-warning { background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; }
        .completed-warning h5 { color: #664d03; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loader" class="text-center">
            <div class="spinner-border text-danger" style="width: 3rem; height: 3rem;" role="status"></div>
            <p class="mt-2">Loading Referral Data...</p>
            <div class="progress mt-3 progress-container" style="height: 6px;">
                <div class="progress-bar bg-danger" id="loadProgress" role="progressbar" style="width: 0%"></div>
            </div>
        </div>

        <!-- Reprocessing Warning Modal -->
        <div class="modal fade" id="reprocessModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">⚠️ Referral Already Completed</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>This referral has already been processed and marked as completed.</strong></p>
                        <p>Are you sure you want to reprocess it? This will:</p>
                        <ul>
                            <li>Allow you to modify the administrative data</li>
                            <li>Create a new Google Doc export</li>
                            <li>Send new completion emails</li>
                            <li>Update the completion timestamp</li>
                        </ul>
                        <p><strong>Original completion date:</strong> <span id="originalCompletionDate"></span></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" id="confirmReprocess">Yes, Reprocess</button>
                    </div>
                </div>
            </div>
        </div>

        <form id="adminForm">
            <input type="hidden" id="submissionNumber" name="submissionNumber">
            <input type="hidden" id="sheetName" name="sheetName">
            <input type="hidden" id="allowReprocess" name="allowReprocess" value="false">
            
            <div class="form-header text-center mb-4">
                <h1>Administrator Referral Review</h1>
                <p class="lead">Review staff submission and complete administrative fields.</p>
            </div>

            <!-- Completed Warning Banner -->
            <div id="completedWarning" class="completed-warning" style="display: none;">
                <h5>⚠️ This referral has already been completed</h5>
                <p class="mb-0">This referral was processed on <span id="completionInfo"></span>. You can view the data below, but modifications will require confirmation.</p>
            </div>

            <!-- Quick Actions Panel -->
            <div class="quick-actions">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="submission-summary">
                            <strong>Submission ID:</strong> <span id="quickSubmissionId">Loading...</span> |
                            <strong>Student:</strong> <span id="quickStudentName">Loading...</span> |
                            <strong>Type:</strong> <span id="quickReferralType">Loading...</span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="printBtn">Print</button>
                        <button type="button" class="btn btn-outline-info btn-sm" id="shareBtn">Share PDF</button>
                    </div>
                </div>
            </div>

            <div class="staff-section">
                <h4>Staff Submission Details</h4>
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label class="form-label">Submission ID</label>
                        <input type="text" class="form-control" id="SubmissionNumber" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Date of Report Submission</label>
                        <input type="text" class="form-control" id="Timestamp" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Referral Type</label>
                        <input type="text" class="form-control" id="ReferralType" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Status</label>
                        <input type="text" class="form-control" id="Status" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Student Name</label>
                        <input type="text" class="form-control field-highlight" id="StudentName" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Student ID</label>
                        <input type="text" class="form-control" id="StudentID" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Referring Staff Name</label>
                        <input type="text" class="form-control" id="StaffName" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Referring Staff Email</label>
                        <input type="text" class="form-control" id="StaffEmail" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Date of Incident</label>
                        <input type="text" class="form-control field-highlight" id="DateOfIncident" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Time of Incident</label>
                        <input type="text" class="form-control" id="TimeOfIncident" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Day of Week</label>
                        <input type="text" class="form-control" id="DayOfWeek" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Grade Level</label>
                        <input type="text" class="form-control" id="GradeLevel" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Team</label>
                        <input type="text" class="form-control" id="Team" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control field-highlight" id="Location" readonly>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Infraction(s)</label>
                        <textarea class="form-control field-highlight" id="Infraction" rows="2" readonly></textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Description of Infraction(s)</label>
                        <textarea class="form-control field-highlight" id="DescriptionOfInfraction" rows="3" readonly></textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Previous Action(s) Taken</label>
                        <textarea class="form-control" id="ActionsTaken" rows="3" readonly></textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Perceived Motivation</label>
                        <textarea class="form-control" id="PerceivedMotivation" rows="2" readonly></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Phone communication with parent/guardian?</label>
                        <input type="text" class="form-control" id="HomeCommunications" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Details of Communication</label>
                        <textarea class="form-control" id="DetailsOfCommunication" rows="1" readonly></textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Other Information or Comments:</label>
                        <textarea class="form-control" id="Comments" rows="2" readonly></textarea>
                    </div>
                </div>
            </div>

            <div class="admin-section">
                <h4>Administrative Action</h4>
                <div class="row g-3 mt-2">
                    <div id="majorAdminActions" class="hidden-section"></div>
                    
                    <div class="col-12">
                        <label for="adminComments" class="form-label">Administrator Comments</label>
                        <textarea class="form-control" id="adminComments" name="AdminComments" rows="4" maxlength="2000" placeholder="Document administrative decisions, parent contact, and follow-up actions..."></textarea>
                        <div class="form-text">Characters remaining: <span id="adminCommentsCounter">2000</span></div>
                        <div class="error-message" id="adminComments-error"></div>
                    </div>
                    
                    <!-- Reward Trip Sections -->
                    <div id="rewardTripSection" class="col-12 mt-3"></div>
                    
                    <!-- Parent Contact Tracking -->
                    <div class="col-12 mt-3">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Parent Contact Tracking</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="parentContactDate" class="form-label">Contact Date</label>
                                        <input type="date" class="form-control" id="parentContactDate" name="ParentContactDate">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="parentContactMethod" class="form-label">Contact Method</label>
                                        <select class="form-select" id="parentContactMethod" name="ParentContactMethod">
                                            <option value="">Select method...</option>
                                            <option value="Phone Call">Phone Call</option>
                                            <option value="Email">Email</option>
                                            <option value="In-Person Meeting">In-Person Meeting</option>
                                            <option value="Letter Sent Home">Letter Sent Home</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label for="parentContactNotes" class="form-label">Contact Notes</label>
                                        <textarea class="form-control" id="parentContactNotes" name="ParentContactNotes" rows="3" maxlength="1000" placeholder="Document conversation details, parent response, follow-up needed..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-danger btn-lg" id="submitBtn">Update and Close Referral</button>
                <button type="button" class="btn btn-secondary" id="saveDraftBtn">Save Progress</button>
            </div>
            
            <div id="output" class="mt-3"></div>
        </form>
    </div>

    <div class="autosave-status" id="autosaveStatus" style="display: none;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const SUBMISSION_ID = '<?!= submissionId ?>';
        let formData = {};
        let autoSaveTimer;
        let isCompleted = false;
        const AUTOSAVE_DELAY = 30000; // 30 seconds
        // Date/time formatting functions
        function formatDateDisplay(dateValue) {
            if (typeof dateValue === 'string' && !dateValue.includes('-') && !dateValue.includes('T')) {
                return dateValue;
            }
            
            if (!dateValue) return '';
            
            let date;
            if (typeof dateValue === 'string' && dateValue.includes('-')) {
                const [year, month, day] = dateValue.split('-');
                date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            } else {
                date = dateValue instanceof Date ? dateValue : new Date(dateValue);
            }
            
            if (isNaN(date.getTime())) return 'Invalid date';
            
            const options = { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            };
            return date.toLocaleDateString('en-US', options);
        }

        function formatTimeDisplay(timeValue) {
            if (typeof timeValue === 'string' && (timeValue.includes('AM') || timeValue.includes('PM'))) {
                return timeValue;
            }
            
            if (!timeValue) return '';
            
            let date;
            if (typeof timeValue === 'string' && timeValue.includes(':') && !timeValue.includes(' ')) {
                const [hours, minutes] = timeValue.split(':');
                date = new Date(2000, 0, 1, parseInt(hours), parseInt(minutes));
            } else {
                date = timeValue instanceof Date ? timeValue : new Date(timeValue);
            }
            
            if (isNaN(date.getTime())) return '';
            
            const options = { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true 
            };
            return date.toLocaleTimeString('en-US', options);
        }

        function initializeAdminForm() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('parentContactDate').value = `${year}-${month}-${day}`;
            
            setupCharacterCounters();
            setupAutoSave();
        }

        // Check status before loading data
        function checkReferralStatusFirst() {
            updateLoadProgress(10, 'Checking referral status...');
            
            google.script.run
                .withSuccessHandler(handleStatusCheck)
                .withFailureHandler(() => {
                    loadSubmissionData();
                })
                .checkReferralStatus(SUBMISSION_ID);
        }

        // Handle status check result
        function handleStatusCheck(statusResult) {
            if (statusResult.isCompleted) {
                isCompleted = true;
                document.getElementById('allowReprocess').value = 'false';
                
                const warningDiv = document.getElementById('completedWarning');
                const completionInfo = document.getElementById('completionInfo');
                
                if (statusResult.completionDate) {
                    completionInfo.textContent = statusResult.completionDate;
                } else {
                    completionInfo.textContent = 'an earlier date';
                }
                
                warningDiv.style.display = 'block';
            }
            
            loadSubmissionData();
        }

        function loadSubmissionData() {
            updateLoadProgress(20, 'Retrieving submission data...');
            
            google.script.run
                .withSuccessHandler(handleDataLoaded)
                .withFailureHandler(showError)
                .getSubmissionDataOptimized(SUBMISSION_ID);
        }

        function updateLoadProgress(percent, message) {
            document.getElementById('loadProgress').style.width = percent + '%';
            const loadingText = document.querySelector('#loader p');
            if (loadingText) loadingText.textContent = message;
        }

        function handleDataLoaded(responseString) {
            updateLoadProgress(60, 'Processing form data...');
            
            setTimeout(() => {
                populateForm(responseString);
                updateLoadProgress(100, 'Complete!');
                
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('adminForm').style.display = 'block';
                }, 500);
            }, 1000);
        }

        function populateForm(responseString) {
            try {
                const response = JSON.parse(responseString);
                if (response.error) {
                    showError({ message: response.error });
                    return;
                }

                const headers = response.headers;
                const data = response.data;
                const record = {};
                
                headers.forEach((header, i) => { 
                    record[header] = data[i] || ''; 
                });

                headers.forEach(header => {
                    const el = document.getElementById(header);
                    if (el) {
                        let value = record[header] || '';
                        if (typeof value === 'string' && value.startsWith("'")) {
                            value = value.substring(1);
                        }
                        el.value = value;
                    }
                });

                document.getElementById('ReferralType').value = response.sheet;
                document.getElementById('quickSubmissionId').textContent = record.SubmissionNumber;
                document.getElementById('quickStudentName').textContent = record.StudentName;
                document.getElementById('quickReferralType').textContent = response.sheet;

                if (record.AdminComments) {
                    document.getElementById('adminComments').value = record.AdminComments;
                }

                if (response.sheet === 'Major') {
                    setupMajorReferralFields(record);
                }

                setupRewardTripSection(record.GradeLevel, record);
                formData = record;
                
                document.getElementById('submissionNumber').value = record.SubmissionNumber;
                document.getElementById('sheetName').value = response.sheet;

            } catch(e) {
                showError({ message: "Failed to parse data from server. " + e.message });
            }
        }
        function setupMajorReferralFields(record) {
            const majorActionsContainer = document.getElementById('majorAdminActions');
            majorActionsContainer.innerHTML = `
                <div class="col-12 mb-3">
                    <label class="form-label">Code of Conduct <span class="text-danger">*</span></label>
                    <div class="p-3 border rounded checkbox-group">
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="1. Disruption of School"><label>1. Disruption of School</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="2. Damage of Property"><label>2. Damage of Property</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="3. PA/Harassment/Threat"><label>3. PA/Harassment/Threat</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="4. Weapons/Dangerous Instruments"><label>4. Weapons/Dangerous Instruments</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="5. Illegal Substances"><label>5. Illegal Substances</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="6. Insubordination/Inappropriate Behaviors"><label>6. Insubordination/Inappropriate Behaviors</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="7. Profanity"><label>7. Profanity</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="8. Truancy/Tardy/Unexcused Absence"><label>8. Truancy/Tardy/Unexcused Absence</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="9. Theft"><label>9. Theft</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="10. Tobacco"><label>10. Tobacco</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="11. Falsification"><label>11. Falsification</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="12. Cafeteria"><label>12. Cafeteria</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="13. Hazing"><label>13. Hazing</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="14. Repeated Acts of Misconduct"><label>14. Repeated Acts of Misconduct</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="15. Bus Conduct"><label>15. Bus Conduct</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CodeOfConduct" value="16. Other School Infractions"><label>16. Other School Infractions</label></div>
                    </div>
                    <div class="error-message" id="CodeOfConduct-error"></div>
                </div>
                
                <div class="col-12 mb-3">
                    <label class="form-label">Ohio State Reporting Codes <span class="text-danger">*</span></label>
                    <div class="p-3 border rounded checkbox-group">
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CRDCReporting" value="Not Applicable"><label>Not Applicable</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CRDCReporting" value="Expelled with Educational Services"><label>Expelled with Educational Services</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CRDCReporting" value="Expelled under Zero Tolerance Policy"><label>Expelled under Zero Tolerance Policy</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CRDCReporting" value="Referral to Law Enforcement"><label>Referral to Law Enforcement</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CRDCReporting" value="School Related Arrest"><label>School Related Arrest</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CRDCReporting" value="Sexual Harassment"><label>Sexual Harassment</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CRDCReporting" value="Harassment based upon Discrimination"><label>Harassment based upon Discrimination</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CRDCReporting" value="Harassment based upon Disability"><label>Harassment based upon Disability</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CRDCReporting" value="Used Mechanical Restraints"><label>Used Mechanical Restraints</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CRDCReporting" value="Used Physical Restraints"><label>Used Physical Restraints</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="CRDCReporting" value="Used Seclusion"><label>Used Seclusion</label></div>
                    </div>
                    <div class="error-message" id="CRDCReporting-error"></div>
                </div>
                
                <div class="col-12 mb-3">
                    <label class="form-label">Administrative Consequences <span class="text-danger">*</span></label>
                    <div class="p-3 border rounded checkbox-group">
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="AdminConsequence" value="Conference with Student"><label>Conference with Student</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="AdminConsequence" value="Conference with Parent"><label>Conference with Parent</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="AdminConsequence" value="Detention Before/After School"><label>Detention Before/After School</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="AdminConsequence" value="Exclusion from Participation"><label>Exclusion from Participation</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="AdminConsequence" value="Educational Assignment"><label>Educational Assignment</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="AdminConsequence" value="Referral to Guidance"><label>Referral to Guidance</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="AdminConsequence" value="Referral to Mediation"><label>Referral to Mediation</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="AdminConsequence" value="Reimbursement for Damage"><label>Reimbursement for Damage</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="AdminConsequence" value="Saturday Detention"><label>Saturday Detention</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="AdminConsequence" value="Suspension"><label>Suspension</label></div>
                        <div class="form-check"><input type="checkbox" class="form-check-input" name="AdminConsequence" value="Other" data-other-target="adminConsequenceOtherText"><label>Other</label></div>
                    </div>
                    <input type="text" class="form-control mt-2 other-text" id="adminConsequenceOtherText" name="adminConsequenceOtherText" placeholder="Please specify other consequence" maxlength="200">
                    <div class="error-message" id="AdminConsequence-error"></div>
                </div>
            `;
            
            majorActionsContainer.style.display = 'block';
            const otherCheckbox = majorActionsContainer.querySelector('input[data-other-target="adminConsequenceOtherText"]');
            if (otherCheckbox) {
                otherCheckbox.addEventListener('change', function() {
                    const otherText = document.getElementById('adminConsequenceOtherText');
                    otherText.style.display = this.checked ? 'block' : 'none';
                    if (!this.checked) otherText.value = '';
                });
            }

            // Pre-populate existing data
            if (record.CodeOfConduct && record.CodeOfConduct.trim()) {
                const values = record.CodeOfConduct.split(', ');
                values.forEach(value => {
                    const trimmedValue = value.trim();
                    const checkbox = document.querySelector(`input[name="CodeOfConduct"][value="${trimmedValue}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            if (record.CRDCReporting && record.CRDCReporting.trim()) {
                const values = record.CRDCReporting.split(', ');
                values.forEach(value => {
                    const trimmedValue = value.trim();
                    const checkbox = document.querySelector(`input[name="CRDCReporting"][value="${trimmedValue}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            if (record.AdminConsequence && record.AdminConsequence.trim()) {
                const values = record.AdminConsequence.split(', ');
                values.forEach(value => {
                    const trimmedValue = value.trim();
                    if (trimmedValue.startsWith('Other: ')) {
                        const otherCheckbox = document.querySelector(`input[name="AdminConsequence"][value="Other"]`);
                        if (otherCheckbox) {
                            otherCheckbox.checked = true;
                            document.getElementById('adminConsequenceOtherText').value = trimmedValue.replace('Other: ', '');
                            document.getElementById('adminConsequenceOtherText').style.display = 'block';
                        }
                    } else {
                        const checkbox = document.querySelector(`input[name="AdminConsequence"][value="${trimmedValue}"]`);
                        if (checkbox) checkbox.checked = true;
                    }
                });
            }
        }

        function setupRewardTripSection(gradeLevel, record) {
            const rewardTripContainer = document.getElementById('rewardTripSection');
            let tripHtml = '';
            
            const grade = parseInt(gradeLevel);
            
            if (grade === 6) {
                tripHtml += createRadioGroupHtml('Swings & Things Reward Trip', 'RewardTripPts', record.RewardTripPts || '');
            } else if (grade === 7) {
                tripHtml += createRadioGroupHtml('Bowling Trip', 'RewardTripPts', record.RewardTripPts || '');
            } else if (grade === 8) {
                tripHtml += createRadioGroupHtml('Cedar Point Trip', 'RewardTripPts', record.RewardTripPts || '');
                tripHtml += createRadioGroupHtml('Washington DC Trip', 'DCPoints', record.DCPoints || '');
            }
            
            if (tripHtml) {
                rewardTripContainer.innerHTML = `
                    <div class="reward-trip-section">
                        <h5 class="mb-3">Reward Trip Point Deductions</h5>
                        ${tripHtml}
                    </div>
                `;
                rewardTripContainer.style.display = 'block';
            }
        }

        function createRadioGroupHtml(title, name, selectedValue) {
            let html = `<div class="mb-4">
                <label class="form-label fw-bold">${title}</label>
                <div class="p-3 border rounded">
                    <div class="radio-button-group">`;
            
            for (let i = 0; i <= 10; i++) {
                const checked = selectedValue == i ? 'checked' : '';
                html += `<div class="form-check">
                    <input class="form-check-input" type="radio" name="${name}" id="${name}${i}" value="${i}" ${checked}>
                    <label class="form-check-label" for="${name}${i}">${i}</label>
                </div>`;
            }
            html += `    </div>
                </div>
            </div>`;
            return html;
        }
        function handleFormSubmit(e) {
            e.preventDefault();
            
            if (isCompleted && document.getElementById('allowReprocess').value !== 'true') {
                const modal = new bootstrap.Modal(document.getElementById('reprocessModal'));
                modal.show();
                return;
            }
            
            proceedWithSubmission();
        }

        function setupEventListeners() {
            document.getElementById('adminForm').addEventListener('submit', handleFormSubmit);
            
            document.getElementById('confirmReprocess').addEventListener('click', function() {
                document.getElementById('allowReprocess').value = 'true';
                const modal = bootstrap.Modal.getInstance(document.getElementById('reprocessModal'));
                modal.hide();
                
                document.getElementById('completedWarning').style.display = 'none';
                isCompleted = false;
                
                proceedWithSubmission();
            });
            
            document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);
            document.getElementById('printBtn').addEventListener('click', printReferral);
            document.getElementById('shareBtn').addEventListener('click', shareReferralPDF);
            
            document.getElementById('adminForm').addEventListener('input', () => {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(autoSave, AUTOSAVE_DELAY);
            });
        }

        function setupCharacterCounters() {
            const adminComments = document.getElementById('adminComments');
            if (adminComments) {
                adminComments.addEventListener('input', function() {
                    const remaining = 2000 - this.value.length;
                    document.getElementById('adminCommentsCounter').textContent = remaining;
                    document.getElementById('adminCommentsCounter').classList.toggle('text-danger', remaining < 100);
                });
            }
        }

        function setupAutoSave() {
            const form = document.getElementById('adminForm');
            const inputs = form.querySelectorAll('input, textarea, select');
            
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(autoSaveTimer);
                    showAutosaveStatus('Changes pending...', 'warning');
                    
                    autoSaveTimer = setTimeout(() => {
                        autoSave();
                    }, AUTOSAVE_DELAY);
                });
            });
        }

        function collectFormData() {
            const form = document.getElementById('adminForm');
            const formObject = {};
            
            const inputs = form.querySelectorAll('input:not([type="checkbox"]):not([type="radio"]), textarea, select');
            inputs.forEach(input => {
                if (input.name && input.value) {
                    formObject[input.name] = input.value;
                }
            });

            const checkboxGroups = {};
            form.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                const name = cb.getAttribute('name');
                if (name) {
                    if (!checkboxGroups[name]) {
                        checkboxGroups[name] = [];
                    }
                    checkboxGroups[name].push(cb.value);
                }
            });
            
            Object.keys(checkboxGroups).forEach(name => {
                formObject[name] = checkboxGroups[name].join(', ');
            });

            form.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                if (radio.name) {
                    formObject[radio.name] = radio.value;
                }
            });

            if (formObject.adminConsequenceOtherText && formObject.AdminConsequence) {
                formObject.AdminConsequence = formObject.AdminConsequence.replace(/\bOther\b/, `Other: ${formObject.adminConsequenceOtherText}`);
            }

            return formObject;
        }

        function validateAdminForm(formData) {
            const errors = [];
            const sheetName = document.getElementById('sheetName').value;
            
            if (sheetName === 'Major') {
                if (!formData.CodeOfConduct) {
                    errors.push('Code of Conduct selection is required for Major referrals');
                }
                if (!formData.CRDCReporting) {
                    errors.push('Ohio State Reporting Code selection is required for Major referrals');
                }
                if (!formData.AdminConsequence) {
                    errors.push('Administrative Consequence selection is required for Major referrals');
                }
            }
            
            return errors;
        }
        function proceedWithSubmission() {
            const submitBtn = document.getElementById('submitBtn');
            const outputDiv = document.getElementById('output');
            
            const formData = collectFormData();
            
            const validationErrors = validateAdminForm(formData);
            if (validationErrors.length > 0) {
                alert('Please fix the following errors:\n\n' + validationErrors.join('\n'));
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            outputDiv.innerHTML = '';
            
            google.script.run
                .withSuccessHandler(response => {
                    outputDiv.innerHTML = `<div class="alert alert-success">${response}</div>`;
                    submitBtn.textContent = 'Updated Successfully';
                    showAutosaveStatus('Referral completed successfully!', 'success');
                    setTimeout(() => window.top.close(), 2500);
                })
                .withFailureHandler(error => {
                    outputDiv.innerHTML = `<div class="alert alert-danger">Update failed: ${error.message}</div>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Update and Close Referral';
                    showAutosaveStatus('Update failed', 'danger');
                })
                .updateRecordSecure(formData);
        }

        function autoSave() {
            const formData = collectFormData();
            
            showAutosaveStatus('Auto-saving...', 'info');
            
            google.script.run
                .withSuccessHandler(() => {
                    showAutosaveStatus('Changes saved automatically', 'success');
                })
                .withFailureHandler(() => {
                    showAutosaveStatus('Auto-save failed', 'danger');
                })
                .autoSaveRecord(formData);
        }

        function saveDraft() {
            const formData = collectFormData();
            
            document.getElementById('saveDraftBtn').disabled = true;
            document.getElementById('saveDraftBtn').textContent = 'Saving...';
            
            google.script.run
                .withSuccessHandler(() => {
                    showAutosaveStatus('Draft saved successfully!', 'success');
                    document.getElementById('saveDraftBtn').disabled = false;
                    document.getElementById('saveDraftBtn').textContent = 'Save Progress';
                })
                .withFailureHandler(() => {
                    showAutosaveStatus('Save failed', 'danger');
                    document.getElementById('saveDraftBtn').disabled = false;
                    document.getElementById('saveDraftBtn').textContent = 'Save Progress';
                })
                .updateRecord(formData);
        }

        function shareReferralPDF() {
            const shareBtn = document.getElementById('shareBtn');
            shareBtn.disabled = true;
            shareBtn.textContent = 'Creating PDF...';
            
            showAutosaveStatus('Generating PDF attachment...', 'info');
            
            const referralData = {
                submissionNumber: document.getElementById('SubmissionNumber').value,
                studentName: document.getElementById('StudentName').value,
                staffName: document.getElementById('StaffName').value,
                dateOfIncident: document.getElementById('DateOfIncident').value,
                location: document.getElementById('Location').value,
                infraction: document.getElementById('Infraction').value,
                description: document.getElementById('DescriptionOfInfraction').value,
                adminComments: document.getElementById('adminComments').value || '',
                referralType: document.getElementById('ReferralType').value
            };
            
            google.script.run
                .withSuccessHandler(response => {
                    showAutosaveStatus('Email draft created in your Gmail!', 'success');
                    shareBtn.disabled = false;
                    shareBtn.textContent = 'Share PDF';
                    alert('Email draft with PDF created in your Gmail drafts!');
                })
                .withFailureHandler(error => {
                    showAutosaveStatus('PDF generation failed', 'danger');
                    shareBtn.disabled = false;
                    shareBtn.textContent = 'Share PDF';
                    alert('PDF generation failed: ' + error.message);
                })
                .createEmailDraftWithPDF(referralData);
        }

        function showAutosaveStatus(message, type = 'info') {
            const statusDiv = document.getElementById('autosaveStatus');
            statusDiv.className = `autosave-status alert alert-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        function showError(error) {
            document.getElementById('loader').innerHTML = `
                <div class="alert alert-danger">
                    <h5>Error Loading Referral</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-outline-danger" onclick="location.reload()">Retry</button>
                </div>
            `;
        }

        function printReferral() {
            const printContent = generatePrintContent();
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Discipline Referral - ${document.getElementById('StudentName').value}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; }
                            .field { margin: 5px 0; }
                            .label { font-weight: bold; }
                            @media print { .no-print { display: none; } }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                        <div class="no-print" style="text-align: center; margin-top: 30px;">
                            <button onclick="window.print()">Print</button>
                            <button onclick="window.close()">Close</button>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }

        function generatePrintContent() {
            return `
                <div class="header">
                    <h1>Discipline Referral Report</h1>
                    <p>Student: ${document.getElementById('StudentName').value} | 
                       Submission: ${document.getElementById('SubmissionNumber').value} |
                       Date: ${formatDateDisplay(new Date())}</p>
                </div>
                <div class="section">
                    <h3>Incident Details</h3>
                    <div class="field"><span class="label">Date of Incident:</span> ${document.getElementById('DateOfIncident').value}</div>
                    <div class="field"><span class="label">Location:</span> ${document.getElementById('Location').value}</div>
                    <div class="field"><span class="label">Staff Member:</span> ${document.getElementById('StaffName').value}</div>
                    <div class="field"><span class="label">Description:</span> ${document.getElementById('DescriptionOfInfraction').value}</div>
                </div>
                <div class="section">
                    <h3>Administrative Action</h3>
                    <div class="field"><span class="label">Administrator Comments:</span> ${document.getElementById('adminComments').value}</div>
                    <div class="field"><span class="label">Status:</span> Completed</div>
                    <div class="field"><span class="label">Processed Date:</span> ${formatDateDisplay(new Date())} at ${formatTimeDisplay(new Date())}</div>
                </div>
            `;
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeAdminForm();
            checkReferralStatusFirst();
            setupEventListeners();
        });

    </script>
</body>
</html>